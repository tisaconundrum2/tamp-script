var om=om||{};
om.promotions=function(){var b=!1,d=!1,a=!1,c=!1,m="",p=function(){return{executePromotionEngine:function(a){var c=om.promotions.logger.promotionsLogger,b=c.createNewMessage();b.addGlobalContext(c.globalContext);c.globalContext=[];b.setTrigger(a);promotions.applyPromo(a,b);b.close();om.promotions.logger.scheduler.schedule(c.logMessages)}}}();return{setPrinting:function(c){a=c},isPrinting:function(){return a},enableNewPromotionEngine:function(a){b=a},isNewPromotionEngineEnabled:function(){return b},getAllowStackLegacyPromoWithNewEngineOn:function(){return d},
setAllowStackLegacyPromoWithNewEngineOn:function(a){d=a},runPromotionEngine:function(a){p.executePromotionEngine(a)},useNewPromotionEngine:function(){return 0===nlapiGetLineItemCount("promotions")&&b||0!==nlapiGetLineItemCount("promotions")&&"T"===nlapiGetLineItemValue("promotions","isnewpromotiontype",1)},setTransactionInDynamicDeferredMode:function(a){c=a},isTransactionInDynamicDeferredMode:function(){return c},setOriginalTransactionType:function(a){m=a},getOriginalTransactionType:function(){return m}}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.common=function(){return{findFirstInMachine:function(b,d,a){for(var c=nlapiGetLineItemCount(b),m=1;m<=c;m++)if(nlapiGetLineItemValue(b,d,m)===a)return m;return null},indexOf:function(b,d){for(var a=0,c=b.length;a<c;a++)if(b[a]==d)return a;return-1},isSuitePromotionsEnabledForThisTransaction:function(){return"T"===nlapiGetFieldValue("canhavestackable")},NLClass:function(b){var d=function(){return this.initialize?this.initialize.apply(this,arguments):this},a;for(a in b)d.prototype[a]=
b[a];return d},machineAdapter:function(){var b={},d=function(a){b[a]||(b[a]={machineName:a,lineAdded:function(a){},lineDeleted:function(a){},recordData:function(a){},validateLine:function(a){return!0},validateDelete:function(a,b){}});return b[a]};return{getMachineInterface:d,validateDeleteListener:function(a){var c=parseInt(nlapiGetCurrentLineItemIndex(a),10);a=d(a);a.validateDelete(parseInt(c,10),a.recordData(c).itemType)},validateLineListener:function(a){var c=parseInt(nlapiGetCurrentLineItemIndex(a),
10);return d(a).validateLine(c)},postDeleteLineListener:function(a,c){d(a).lineDeleted(parseInt(c,10))},lineCommitListener:function(a,c){d(a).lineAdded(parseInt(c,10))}}}(),FIELDS:{AUTOMATICALLY_APPLY_PROMOTIONS:"automaticallyapplypromotions"},ITEM_MACHINE:{AMOUNT:"amount",CUSTREFERRALCODE:"custreferralcode",DISCOUNT:"Discount",ITEM:"item",ITEMTYPE:"itemtype",NAME:"item",QUANTITY:"quantity",RATE:"rate",TAXCODE:"taxcode"},PROMOTIONS_MACHINE:{NAME:"promotions",PROMO_CODE:"promocode",PROMOTION_TYPE:"promotiontype",
APPLICABILITY_STATUS:"applicabilitystatus",APPLICABILITY_REASON:"applicabilityreason",PURCHASE_DISCOUNT:"purchasediscount"},PROMOTION_TYPES:{STANDARD:"STANDARD",ADVANCED:"ADVANCED",ITEM:"ITEM",ORDER:"ORDER",SHIPPING:"SHIPPING",FIXEDPRICE:"FIXEDPRICE",FREEGIFT:"FREEGIFT"},PROMOTION_DOES_NOT_APPLY_SYMBOL:"-",STATUS:{APPLIED:"APPLIED",NOT_APPLIED:"NOT_APPLIED"},REASON:{NOT_AVAILABLE:"N/A",NO_FREE_GIFTS_ADDED:"NO_FREE_GIFTS_ADDED",CRITERIA_NOT_MET:"CRITERIA_NOT_MET"},APPLY_PROMO_TRIGGER:{EVENT_ITEM_MACHINE_RECALC:"itemMachineRecalc"}}}();var PromotionLoggerScheduler=new om.promotions.common.NLClass({initialize:function(b){this.enabled=b;this.scheduledTimeOut=null;this.timeInMilliseconds=5E3},schedule:function(b){this.enabled&&(om.promotions.form.isUserInterface()?(null!==this.scheduledTimeOut&&clearTimeout(this.scheduledTimeOut),this.scheduledTimeOut=setTimeout(b,this.timeInMilliseconds)):b())},setEnabled:function(b){this.enabled=b}});om=om||{};om.promotions=om.promotions||{};
om.promotions.logger=function(){var b=new (new om.promotions.common.NLClass({initialize:function(a,c){this.javaScriptOperationId=nlapiGetContext().company+"-"+Date.now()+"-"+Math.random().toString(36).substr(2)+Math.random().toString().substr(2);this.name=a;this.enabled=c;this.logString="";this.stackMessages=[];this.globalContext=[]},setEnabled:function(a){this.enabled=a},isEnabled:function(){return this.enabled},getStackMessages:function(){return this.stackMessages},setStackMessages:function(a){return this.stackMessages=
a},log:function(){if(this.enabled){if(1==arguments.length){var a=null;var c=arguments[0]}else 2==arguments.length&&(a=arguments[0],c=arguments[1]);a&&(this.logString+=a+": ");"string"!=typeof c&&(c=JSON.stringify(c,null,"\t"));this.logString+=c+"\n"}},logLegacyPromotionEngineOutput:function(a,c){if(this.enabled){this.log("\nLegacyPromotionEngineOutput",a);for(var b in c)c.hasOwnProperty(b)&&(a=JSON.parse(c[b]),this.log("\n Promotion id "+b+": \n",a),a.legacyPromotionOutput&&this.log("\n",a.legacyPromotionOutput))}},
getLog:function(){return this.logString},reset:function(){this.logString=""},logMessages:function(){var a=om.promotions.logger.promotionsLogger;if(a.isEnabled()&&a.getStackMessages()&&0<a.getStackMessages().length){var c=a.removeAndReturnCloseMessages(a.getStackMessages());a=[(new PromotionMessageJSONConverter(c)).convertToJson(a.javaScriptOperationId)];om.promotions.form.isUserInterface()?nlapiServerCall("/app/crm/sales/logger/promotionloggerhandler.nl","log",a,function(a,c){}):nlapiServerCall("/app/crm/sales/logger/promotionloggerhandler.nl",
"log",a)}},removeAndReturnCloseMessages:function(){for(var a=om.promotions.logger.promotionsLogger.getStackMessages(),c=[],b=[],d=0;d<a.length;d++){var h=a[d];om.promotions.logger.MESSAGE_STATE.OPEN===h.getState()?b.push(h):c.push(h)}om.promotions.logger.promotionsLogger.setStackMessages(b);return c},createNewMessage:function(){var a=new PromotionMessage(this.enabled);this.enabled&&this.getStackMessages().push(a);return a},addToContext:function(a){if(this.enabled)for(var b in a)if(a.hasOwnProperty(b)){var d=
{};d[b]=a[b];this.globalContext.push(d)}},dump:function(){if(this.enabled){var a=this.name+": \n"+this.getLog();this.print(a);this.reset()}},printMessages:function(a,b){if(this.enabled){a="undefined"!==typeof a?a:!1;b="undefined"!==typeof b?b:"";var c="";if(0<this.getStackMessages().length)for(var d=0;d<this.getStackMessages().length;d++){var h=this.getStackMessages()[d];if(!b||b==h.getType()){c+="-----------------------------------------------------\n";c+="Trigger: "+h.getTrigger()+", ";c+="Type: "+
h.getType()+", ";c+="Date : "+h.getDateMessage()+", ";c+="MethodsTree : "+h.getTimeTableMethodsTree()+", ";c+="|- Context \n";for(var f=0;f<h.getLocalContext().length;f++){var g=h.getLocalContext()[f],v=Object.keys(g)[0];g=g[Object.keys(g)[0]];g=g===Object(g)?JSON.stringify(g):g;c=a||"applyPromo.promoEngineOutput"!=v?c+("|- "+f+": "+v+": "+g+"\n"):c+("|- "+f+": Promotions output OMITTED, to include promotions output set showPromoOutput to true \n")}}}return c}},print:function(a){window.console&&window.console.debug?
window.console.debug(a):window.console&&window.console.log&&window.console.log(a)}}))("promotionsLogger","T"===nlapiGetContext().getPreference("USE_PROMOTION_LOGGER")),d=new PromotionLoggerScheduler("T"===nlapiGetContext().getPreference("USE_PROMOTION_LOGGER"));return{MESSAGE_TYPE:{ATTEMPT:"ATTEMPT",ERROR:"ERROR",CALL:"CALL"},MESSAGE_STATE:{OPEN:"OPEN",CLOSE:"CLOSE"},TRIGGER_TYPE:{ADD_MULTIPLE_ITEM_CALLBACK:"addMultipleItemCallback",AUTO_APPLY:"autoApply",BTN_CALCULATE:"btnCalculate",DISCOUNT_RATE_CHANGED:"discountRateChanged",
IS_MULTI_SHIP_TO_CHANGED:"isMultiShipToChanged",ITEM_MACHINE_RECALC:"itemMachineRecalc",LOCATION_CHANGED:"locationChanged",PAGE_INIT:"pageInit",PROMO_CODE:"promocode",PROMO_MACHINE_CHANGED:"promoMachineChanged",PROMO_MACHINE_CLEARED:"promoMachineCleared",PROMO_MACHINE_LINE_DELETED:"promoMachineLineDeleted",RECALC:"recalc",SHIPMETH:"shipmeth",SHIPPING_COST_CHANGED:"shippingCostChanged",SHIPPING_GROUP_LINE_COMMIT:"shippingGroupLineCommit",SHIPPING_GROUPS_CLEARED:"shippingGroupsCleared",SYNC_ITEM_MACHINE_PRICE:"syncItemMachinePrice",
TRAN_DATE_CHANGED:"tranDateChanged",UNDEFINED:"undefined"},promotionsLogger:b,scheduler:d}}();
var PromotionMessageJSONConverter=new om.promotions.common.NLClass({initialize:function(b){this.stackMessages=b},convertToJson:function(b){for(var d=[],a,c=0;c<this.stackMessages.length;c++)a=this.stackMessages[c],a={trigger:a.getTrigger(),type:a.getType(),dateMessage:a.getDateMessage(),localContext:this.convertLocalContext(a.getLocalContext()),timeTable:a.getTimeTable(),methodsTree:a.getTimeTableMethodsTree()},d.push(a);return JSON.stringify({stackMessages:d,javaScriptOperationId:b})},convertLocalContext:function(b){var d=
[];if("undefined"!==typeof b)for(var a in b)if(b.hasOwnProperty(a)){var c=b[a],m=Object.keys(c)[0];d.push({key:m,value:c[m]})}return d}});var TIMETABLE={BEGIN:"BEGIN",END:"END"},repeatString=function(b,d){var a="";if(b)for(var c=0;c<d;c++)a+=b;return a},PromotionTimeTable=new om.promotions.common.NLClass({initialize:function(){this.timeTable=[];this.beginTable=[]},getTimeTable:function(){return this.timeTable},begin:function(b){b={name:b,time:(new Date).getTime(),label:TIMETABLE.BEGIN};this.timeTable.push(b);this.beginTable.push(b)},end:function(b){this.isValidEndMethod(b)||this.throwExceptionInvalidEndMethod();this.timeTable.push({name:b,
time:(new Date).getTime(),label:TIMETABLE.END});this.beginTable.pop()},isValidEndMethod:function(b){return 0===this.beginTable.length?!1:this.beginTable[this.beginTable.length-1].name==b},throwExceptionInvalidEndMethod:function(){if("userinterface"===nlapiGetContext().getExecutionContext())throw promotions.promoLanguages.error.THE_METHOD_DOES_NOT_HAVE_A_BEGINNING_FOR_TRACKING_THE_TIME_OR_IS_BEING_ENDED_WHEN_THERE_IS_INNER_METHOD_OPENED;throw nlapiCreateError("THE_METHOD_DOES_NOT_HAVE_A_BEGINNING_FOR_TRACKING_THE_TIME_OR_IS_BEING_ENDED_WHEN_THERE_IS_INNER_METHOD_OPENED",
promotions.error.THE_METHOD_DOES_NOT_HAVE_A_BEGINNING_FOR_TRACKING_THE_TIME_OR_IS_BEING_ENDED_WHEN_THERE_IS_INNER_METHOD_OPENED,!0);},print:function(){for(var b="",d=1,a=[],c=0;c<this.timeTable.length;c++){var m=this.timeTable[c];if(m.label===TIMETABLE.BEGIN)b+=repeatString("-",d)+" "+m.name+"\n",a.push(m),d++;else{d--;var p=a.pop();b+=repeatString("-",d)+" "+m.name+" was executed in "+(m.time-p.time)+" ms\n"}}return b}});var PromotionMessage=new om.promotions.common.NLClass({initialize:function(){this.trigger=om.promotions.logger.TRIGGER_TYPE.UNDEFINED;this.type=om.promotions.logger.MESSAGE_TYPE.ATTEMPT;this.dateMessage=(new Date).getTime();this.localContext=[];this.timeTable=new PromotionTimeTable;this.state=om.promotions.logger.MESSAGE_STATE.OPEN},setTrigger:function(b){this.trigger=b},getTrigger:function(){return this.trigger},setType:function(b){this.type=b},getType:function(){return this.type},getDateMessage:function(){return this.dateMessage},
getLocalContext:function(){return this.localContext},getTimeTable:function(){return this.timeTable.getTimeTable()},getTimeTableMethodsTree:function(){return this.timeTable.print()},getState:function(){return this.state},addToContext:function(b){if(om.promotions.logger.promotionsLogger.isEnabled())for(var d in b)if(b.hasOwnProperty(d)){var a={};a[d]=b[d];this.localContext.push(a)}},addGlobalContext:function(b){if(om.promotions.logger.promotionsLogger.isEnabled())for(var d=0;d<b.length;d++)this.localContext.push(b[d])},
begin:function(b){om.promotions.logger.promotionsLogger.isEnabled()&&this.timeTable.begin(b)},end:function(b){om.promotions.logger.promotionsLogger.isEnabled()&&this.timeTable.end(b)},close:function(){this.state=om.promotions.logger.MESSAGE_STATE.CLOSE}});om=om||{};om.promotions=om.promotions||{};var omPromotions=om.promotions,promotionsCommon=omPromotions.common,PROMOTIONS=promotionsCommon.PROMOTIONS_MACHINE.NAME,PROMO_CODE=promotionsCommon.PROMOTIONS_MACHINE.PROMO_CODE,PROMOTION_TYPE=promotionsCommon.PROMOTIONS_MACHINE.PROMOTION_TYPE;
om.promotions.common.freegift=function(){return{CONSTANTS:{FREE_GIFT_STATUS_NEW:"NEW",FREE_GIFT_STATUS_CHANGED:"CHANGED",FREE_GIFT_STATUS_UNCHANGED:"UNCHANGED",ITEM_MACHINE_FREEGIFTPROMOTION:"freegiftpromotion",PROMOTIONS_MACHINE_FREEGIFTPERPROMO:"freegiftperpromotion",FREE_GIFTS_ADDED:"freegiftsadded",ELIGIBLE_FREE_GIFTS:"eligiblefreegifts"},findFreeGiftPromotionIndex:function(b){var d=-1;if(!om.utils.isValueDefined(b)||0>b)return d;for(var a=nlapiGetLineItemCount(PROMOTIONS),c=1;c<=a;c++)if(parseInt(b)===
parseInt(nlapiGetLineItemValue(PROMOTIONS,PROMO_CODE,c))&&promotionsCommon.PROMOTION_TYPES.FREEGIFT===nlapiGetLineItemValue(PROMOTIONS,PROMOTION_TYPE,c)){d=c;break}return d}}}();var promotions=function(){function b(a){var b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].getError();om.promotions.webstore.setPromoError(c);om.promotions.shipping.isMultiShippingRouteError(c)&&(c=promotions.getErrorTranslation(c.errorMsg),void 0!==c&&alert(c),promotions.setIsPromotionEngineDisabled(!1),promotions.isTransactionInStackableMode()||nlapiSetFieldValue("promocode",""))}}function d(){return"T"===nlapiGetFieldValue("islegacypromo")||"T"!==nlapiGetFieldValue("iseditbilledtransactionwithpromotion")&&
"T"!==nlapiGetFieldValue("istransformedbill")&&a()&&""!==nlapiGetFieldValue("entity")&&p()}function a(){return!l||"T"!==nlapiGetFieldValue("istransformedtransaction")||"opprtnty"===om.promotions.getOriginalTransactionType()||"salesorder"===nlapiGetRecordType()}function c(a){var b="T"===nlapiGetFieldValue(x)&&0<nlapiGetLineItemCount(e),c=0===om.promotions.form.getPromotionsInTransaction().length,w=m();"undefined"!=typeof a&&a.addToContext({"applyPromo.runNewEngineIfNeeded.shouldNewEngineRun.isAutoApply":"T"===
nlapiGetFieldValue(x),"applyPromo.runNewEngineIfNeeded.shouldNewEngineRun.isItemMachineEmpty":0<nlapiGetLineItemCount(e),"applyPromo.runNewEngineIfNeeded.shouldNewEngineRun.isPromotionMachineEmpty":c,"applyPromo.runNewEngineIfNeeded.shouldNewEngineRun.shouldNewEngineBeUsed":w});return w&&(!c||b)}function m(){return om.promotions.useNewPromotionEngine()&&"T"==nlapiGetFieldValue("canhavestackable")}function p(){for(var a=nlapiGetRecordType().toLowerCase(),b=0;b<C.length;b++)if(0===a.lastIndexOf(C[b],
0))return!0;return!1}function h(){"undefined"==typeof t&&(t=nlapiGetFieldValue("discountitem")!=nlapiGetFieldValue("promodiscount"))}function f(a){"couponcode"!=a&&(nlapiSetFieldValue("couponcode",nlapiGetFieldValue("muccpromocodeinstance"),!1),om.promotions.form.isUserInterface()&&""==nlapiGetFieldValue("couponcode")&&nlapiSetFieldText("couponcode","",!1));om.promotions.runPromotionEngine("promocode")}function g(){var a,b,c;if("undefined"!=typeof G.avoidValidateIncompatiblePromotions&&G.avoidValidateIncompatiblePromotions)return!0;
var d=b=c=a=!1;var n=!1;var e=null;var k=nlapiGetLineItemCount("promotions"),g=nlapiGetCurrentLineItemIndex("promotions"),f=nlapiGetCurrentLineItemValue("promotions","isnewpromotiontype",g),q=[],t=[];g>k&&(k=g);if(1<k)for(var h,B,l,u,p,r=1;r<=k;r++)r!=g?(h=nlapiGetLineItemValue("promotions","promocode",r),B=nlapiGetLineItemText("promotions","promocode",r),l=nlapiGetLineItemText("promotions","couponcode",r),u=nlapiGetLineItemValue("promotions","isnewpromotiontype",r),p="T"==nlapiGetLineItemValue("promotions",
"cannotbecombined",r)):(h=nlapiGetCurrentLineItemValue("promotions","promocode",r),B=nlapiGetCurrentLineItemText("promotions","promocode",r),l=nlapiGetCurrentLineItemText("promotions","couponcode",r),u=nlapiGetCurrentLineItemValue("promotions","isnewpromotiontype",r),p="T"==nlapiGetCurrentLineItemValue("promotions","cannotbecombined",r)),""!=l?(-1!=t.indexOf(l,0)?n=d=!0:-1!=q.indexOf(h,0)&&(d=!0,e=B),t.push(l)):-1!=q.indexOf(h,0)&&(d=!0,e=B),q.push(h),""!=f&&""!=u&&(a=a||f!==u,b=b||"F"===f&&f===u),
c=c||p;if(d)return n?alert(z.error.A_COUPON_CODE_CAN_ONLY_BE_ADDED_ONCE):alert(z.error.THIS_COUPON_CODE_REFERS_TO_A_PROMOTION_1_THIS_PROMOTION_HAS_BEEN_ALREADY_ADDED__A_PROMOTION_CAN_ONLY_BE_ADDED_ONCE__PLEASE_USE_ANOTHER_COUPON_CODE.replace("{1}",e)),!1;if(a||b&&om.promotions.isNewPromotionEngineEnabled()&&!om.promotions.getAllowStackLegacyPromoWithNewEngineOn())return alert(z.error.THE_PROMOTIONS_YOU_ARE_TRYING_TO_APPLY_CANNOT_BE_COMBINED),!1;if(c){if(!om.promotions.form.isUserInterface()&&"T"!==
nlapiGetFieldValue(x))throw nlapiCreateError("THE_PROMOTIONS_YOU_ARE_TRYING_TO_APPLY_TO_THE_TRANSACTION_CANNOT_BE_COMBINED","The promotions you are trying to apply to the transaction cannot be combined.",!0);if(!m()){d=nlapiGetCurrentLineItemText("promotions","promocode");e=om.promotions.form.getCurrentStackablePromotionsInTransaction(!0);e=K(e,"getCurrentPromotionAmount");c=nlapiGetLineItemCount("promotions");n=[c];for(b=0;b<=c;b++)nlapiGetCurrentLineItemIndex("promotions")!=b+1&&(n[b]=nlapiGetLineItemText("promotions",
"promocode",b+1));c=om.promotions.form.getStackablePromotionsInTransaction(!0);c=K(c,"getOtherPromotionsAmount");om.promotions.window.openWithConflictiveGlobalAndOldEngine({currentPromotion:d,currentPromotionAmount:e,otherPromotions:n,otherPromotionsAmount:c},z.heading.CONFIRMATION);return!1}}return!0}var v=om.promotions.common,x=v.FIELDS.AUTOMATICALLY_APPLY_PROMOTIONS,e=v.ITEM_MACHINE.NAME,n=om.promotions.common.ITEM_MACHINE.ITEM,q=v.APPLY_PROMO_TRIGGER.EVENT_ITEM_MACHINE_RECALC,u=void 0,l=!1,k=
!1,t=void 0,r=!0,y=!1,C=[],A=!1,D=function(){"cashrefund"==nlapiGetRecordType().toLowerCase()&&nlapiSetCurrentLineItemValue("promotions","discountrate","",!1)},E=function(a,b,c,d){return nlapiGetLineItemCount(a)>=c?nlapiGetLineItemValue(a,b,c):3<arguments.length?d:""},B=function(){function a(a,b){for(var c=0;c<a.length;c++)void 0===b[a[c].promotion]&&nlapiSetLineItemValue("promotions","promotionisvalid",a[c].machineOrdinal,"F")}function c(a,b){if(b.legacyPromotionOutput&&!l)b=new I(b.legacyPromotionOutput),
b.apply(n),u=b,synctotal();else{if(b.orderDiscount&&!l){a=b.orderDiscount;var c=b.discountItemId;if(null!=c&&-1!=c){var d=-a.discountRate;d=format_rate(d,a.isPercent);nlapiSetFieldValue("discountitem",c,!0,!0);"virtualbrowser"==nlapiGetContext().getExecutionContext()&&Syncdiscountitem();nlapiSetFieldValue("discountrate",d,!0,!0)}}else om.promotions.items.applyLineLevelDiscounts(a,b),om.promotions.items.freegift.updateChangedFreeGifts(b);a=n;if(c=null!=nlapiGetField("shipmethod"))c=nlapiGetFieldValue("shipmethod"),
c=!(""!==nlapiGetRecordId()&&null!==nlapiGetRecordId()&&!om.promotions.shipping.isMultiShippingRoute()&&k(b,c));if(c)if(c=b.promotionalShippingMethod,d=b.promotionalShippingCarrier,("promocode"==a.triggeringFieldName||l)&&c&&-1!=c&&d&&(om.promotions.webstore.isWebStoreRequest()&&!om.promotions.webstore.isValidWebstoreShippingMethod(a.shippingItems,c)?om.promotions.webstore.setPromoError({errorMsg:"NO_APPLICABLE_SHIPPING_METHOD_FOUND",errorParams:[]}):l&&A||m()||(nlapiSetFieldValue("shipcarrier",d,
!0,!0),nlapiSetFieldValue("shipmethod",c,!0,!0))),b.isItemSpecificFreeShipping()){a=b.getExcludeFromRateRequest();c=nlapiGetFieldValue("shipmethod");if(om.promotions.items.getPromoOutputLineNumbersWereAdjusted()){d=a.lineNums;for(var w=nlapiGetLineItemCount(e),F=1;F<=w;F++)if(nlapiGetLineItemValue(e,"custreferralcode",F))for(var f=0;f<d.length;f++)d[f]>=F&&d[f]++;a.lineNums=d}if(om.promotions.shipping.isMultiShippingRoute()){c=[];for(d=0;d<a.lineNums.length;d++)w=nlapiGetLineItemValue(e,"shipmethod",
a.lineNums[d]),-1<indexOf(a.shippingItemIds,w)&&c.push(a.lineNums[d]);g(c)}else-1<v.indexOf(a.shippingItemIds,c)&&g(a.lineNums);b.setExcludeFromRateRequest(a)}else{a=b.getUpdatedShippingItems();if("function"==typeof updateShippingCost){if(a&&0<a.length&&(!m()||om.promotions.engine.getShippingDiscountIsKnown())){for(c=0;c<a.length;++c)d=a[c],d.getShippingItemId()==nlapiGetFieldValue("shipmethod")&&(!l||isNaN(nlapiGetFieldValue("shippingcost"))||d.getShippingCost()<nlapiGetFieldValue("shippingcost"))&&
(updateShippingCost(d.getShippingCost()),updateHandlingCost(d.getHandlingCost()),nlapiSetFieldValue("shippingcostoverridden","F",!1,!0),y=!0);synctotal()}om.promotions.webstore.setUpdatedShipCostList(a)}if((a=b.getUpdatedShippingGroupItems())&&0<a.length){for(c=0;c<a.length;c++)om.promotions.form.updateShippingGroupCost(a[c].shippingGroupLineNumber,a[c].shippingCost,a[c].handlingCost),y=!0;synctotal()}}om.promotions.webstore.setExcludeFromRateRequest(b.getExcludeFromRateRequest())}}var d=[],n,k=function(a,
c){if("undefined"!=typeof a.getUpdatedShippingItems()&&0<a.getUpdatedShippingItems().length){for(var b=0;b<a.getUpdatedShippingItems().length;b++){var d=a.getUpdatedShippingItems()[b].getShippingItemId();if(!isNaN(d)&&c===d.toString())return!1}return!0}return 0<a.getExcludeFromRateRequest().shippingItemIds.length?(d=a.promotionalShippingMethod,!isNaN(d)&&c!==d.toString()):!1},g=function(a){for(var c=nlapiGetLineItemCount(e),b=a.length,d=0;d<b;d++)a[d]<=c&&(nlapiSelectLineItem(e,a[d]),nlapiSetCurrentLineItemValue(e,
"excludefromraterequest","T"),nlapiCommitLineItem(e));y=!0};return{execute:function(w,e){e.begin("promotionEngineController.execute");var k=om.promotions.form.getPromotionsInTransaction();if(0==k.length)om.promotions.items.removePromotionLineItemDiscounts([]),!l||om.promotions.isTransactionInDynamicDeferredMode()&&w===om.promotions.common.APPLY_PROMO_TRIGGER.EVENT_ITEM_MACHINE_RECALC||om.promotions.items.freegift.removeNotValidFreeGiftsAndDiscounts();else{n=om.promotions.form.collectDataForLegacyEngine(k,
om.promotions.items.getItemLines(),w);d=m()?om.promotions.engine.getLegacyPromotionEngineOutput():om.promotions.engine.runLegacy(n);b(d);if(om.promotions.webstore.ignoreResultDueToOptimization()){e.end("promotionEngineController.execute");return}om.promotions.items.removePromotionLineItemDiscounts(d);l&&(om.promotions.items.freegift.removeNotValidFreeGiftsAndDiscounts(d),a(k,d));var F=[],g;for(g in d)if(d.hasOwnProperty(g)){var f=d[g];if(f.errorCode&&"NO_ERROR"!=f.errorCode.errorMsg&&"NO_APPLICABLE_SHIPPING_METHOD_FOUND"!=
f.errorCode.errorMsg){if(l)for(w=0;w<k.length;w++)k[w].promotion==g&&(nlapiSetLineItemValue("promotions","promotionisvalid",k[w].machineOrdinal,"F"),nlapiSetLineItemValue("promotions","promotioncodeerror",k[w].machineOrdinal,JSON.stringify(f.errorCode)))}else{if(l){for(w=0;w<k.length;w++)if(k[w].promotion==g){var q=nlapiSetLineItemValue,h=k[w].machineOrdinal;var J="undefined"!=typeof f.applicability&&f.applicability.getStatus()===v.STATUS.NOT_APPLIED?"F":"T";q("promotions","promotionisvalid",h,J);
nlapiSetLineItemValue("promotions","promotioncodeerror",k[w].machineOrdinal,JSON.stringify(f.errorCode));f.orderDiscount&&(q=f.discountItemId,h=f.orderDiscount.discountRate,J=f.orderDiscount.isPercent?"%":"",h=-format_rate(h,f.isPercent)+J,nlapiSetLineItemValue("promotions","discount",k[w].machineOrdinal,String(q)),nlapiSetLineItemValue("promotions","discountrate",k[w].machineOrdinal,h))}om.promotions.freegifts.resumingmechanism.shouldResumeMechanismRun()&&f.freeGifts.forEach(function(a){a.discountItemId=
f.discountItemId;F.push(a)})}c(g,f)}}om.promotions.freegifts.resumingmechanism.shouldResumeMechanismRun()&&om.promotions.freegifts.resumingmechanism.loadNewFreeGifts(F)}synctotal();e.end("promotionEngineController.execute")},getCurrentPromotionsOutput:function(){return d},unapplyPromoOutput:function(a){t||"promocode"!=a&&"F"!=nlapiGetFieldValue("islegacypromo")||(nlapiSetFieldValue("discountrate","",!0,!0),nlapiSetFieldValue("discountitem","",!0,!0));a="undefined"!==typeof nlapiGetFieldValue("id");
r=r&&a&&om.promotions.shipping.hasShippingRates();if(y){a=nlapiGetLineItemCount(e);for(var c=1;c<=a;c++)"T"===nlapiGetLineItemValue(e,"excludefromraterequest",c)&&(nlapiSelectLineItem(e,c),nlapiSetCurrentLineItemValue(e,"excludefromraterequest","F"),nlapiCommitLineItem(e));om.promotions.shipping.isMultiShippingRoute()&&(om.promotions.shipping.restoreShippingGroupsIfNotBeingCalculated(),synctotal())}!y&&!r||om.promotions.shipping.isMultiShippingRoute()||""===nlapiGetFieldValue("shipmethod")||(getShippingItemRate(),
synctotal());r=y=!1;om.promotions.webstore.setPromoError({errorMsg:"NO_ERROR",errorParams:[]});om.promotions.webstore.setExcludeFromRateRequest(null);om.promotions.webstore.setPromoShipCostList([])}}}(),I=new om.promotions.common.NLClass({initialize:function(a){this.promoImpact={};this.options=a;this.error={};this.error.errorMsg="NO_ERROR";this.error.errorParams=[];this.hasEligibleLine=!1},setError:function(a,c){this.error.errorMsg=a;c&&(this.error.errorParams=[c])},isMinAmtMet:function(){var a=nlapiGetFieldValue("currency");
if(!this.options.minAmounts[a])return!0;var c=0;if(nlapiGetSubList(e))for(var b=1,d=nlapiGetLineItemCount(e);b<=d;b++){var n=nlapiGetLineItemValue(e,"itemtype",b);om.promotions.items.isProperItemType(n)&&(n=parseFloat(nlapiGetLineItemValue(e,"amount",b).replace(/,/g,"")),c+=n)}return c<this.options.minAmounts[a]?(this.setError("A_MINIMUM_ORDER_AMOUNT_OF_1_IS_REQUIRED_TO_USE_THIS_COUPON_CODE",this.options.minAmounts[a]),!1):!0},flatDiscountIsConvertedToPercentage:function(){var a=nlapiGetFieldValue("discountrate");
return!this.options.isPercent&&a&&-1<a.indexOf("%")},applyDiscount:function(){var a="-"+this.options.discountRate;a=format_rate(a,this.options.isPercent);-1!=this.options.discountId&&nlapiSetFieldValue("discountrate",a,!0,!0);this.calculateDiscountBasis()},calculateDiscountBasis:function(){if(0<this.options.items.length){itemcoupontotal=0;var a=this.calculateDiscountBasisAsObject();itemcoupontotal=a.itemcoupontotal;this.promoImpact.discountbasis=a.itemcoupontotal;nlapiGetLineItemField(e,"altsalesamt")&&
(this.promoImpact.asa_discountbasis=a.itemcouponasatotal);this.promoImpact.discountable_tax_total=a.itemcoupontaxtotal;this.options.isPercent||(this.promoImpact.tran_discamt=-Math.min(parseFloat(this.options.discountRate),a.itemcoupontotal));null!=nlapiGetLineItemField(e,"taxrate2")&&(this.promoImpact.discountable_tax_total2=a.itemcoupontax2total)}},calculateForStackedPromotion:function(){this.setHasEligibleLine();return this.calculateDiscountBasisAsObject()},calculateItemCouponTax:function(a){var c=
nlapiGetFieldValue("taxrate")||"",b=!nlapiGetField("istaxable")||"T"==nlapiGetFieldValue("istaxable"),d=parseFloat(nlapiGetLineItemValue(e,"amount",a).replace(/,/g,"")),n=0,w=null!=nlapiGetLineItemField(e,"taxrate1");if(b&&(!nlapiGetLineItemField(e,"istaxable")||"T"==nlapiGetLineItemValue(e,"istaxable",a)))if(b=(b=nlapiGetLineItemValue(e,"taxableamt",a))?parseFloat(b):d,isNaN(b)&&(b=d),w){c=(nlapiGetLineItemValue(e,"taxrate1",a)||"").replace("%","");if(!isNaN(d)&&null!=nlapiGetLineItemField(e,"quantity")&&
null!=nlapiGetLineItemField(e,"rate")){var k=parseFloat(nlapiGetLineItemValue(e,"quantity",a));isNaN(k)&&(k=1);a=parseFloat(nlapiGetLineItemValue(e,"rate",a));k=parseFloat(k*a)}n=0<c.length&&0!=parseFloat(c)&&!isNaN(k)&&round_currency(d)==round_currency(k)?k*parseFloat(c)/100:parseFloat(d)*(c.length?parseFloat(c)/100:0)}else n=parseFloat(b)*(c.length?parseFloat(c)/100:0);return 0+n},calculateItemCouponTax2:function(a){var c=0,b=parseFloat(nlapiGetLineItemValue(e,"amount",a).replace(/,/g,""));null!=
nlapiGetLineItemField(e,"taxrate2")&&(a=nlapiGetLineItemValue(e,"taxrate2",a)||"",b=parseFloat(b)*(a.length?parseFloat(a)/100:0),c+=b);return c},calculateItemCouponAsTotal:function(a){var c=0;if(a=nlapiGetLineItemValue(e,"altsalesamt",a))a=parseFloat(a.replace(/,/g,"")),c+=a;return c},calculateDiscountBasisAsObject:function(){var a=null,c=null,b=null,d=null;0<this.options.items.length&&(d=b=c=a=0);if(this.hasEligibleLine&&nlapiGetSubList(e))for(var k=nlapiGetLineItemCount(e),f=1;f<=k;f++){var g=nlapiGetLineItemValue(e,
"itemtype",f);-1==v.indexOf(["Subtotal","EndGroup","Description","Group"],g)&&(g=nlapiGetLineItemValue(e,n,f),om.promotions.items.canApplyTo(g,this.options.items,this.options.isWhiteList)?(d+=parseFloat(nlapiGetLineItemValue(e,"amount",f).replace(/,/g,"")),a+=this.calculateItemCouponTax(f),c+=this.calculateItemCouponTax2(f),b+=this.calculateItemCouponAsTotal(f),setEncodedValue(e,f,"itemcouponapplies","T")):setEncodedValue(e,f,"itemcouponapplies","F"))}return{itemcoupontaxtotal:a,itemcoupontax2total:c,
itemcouponasatotal:b,itemcoupontotal:d}},setHasEligibleLine:function(){this.hasEligibleLine=!1;if(0<this.options.items.length){if(nlapiGetSubList(e))for(var a=nlapiGetLineItemCount(e),c=1;c<=a;c++){var b=nlapiGetLineItemValue(e,"itemtype",c);if(om.promotions.items.isProperItemType(b)&&(b=getEncodedValue(e,c,"item"),om.promotions.items.canApplyTo(b,this.options.items,this.options.isWhiteList))){this.hasEligibleLine=!0;break}}this.hasEligibleLine||this.setError("NO_APPLICABLE_ITEMS_FOUND")}},canApplyTo:function(a){return om.promotions.items.canApplyTo(a,
this.options.items,this.options.isWhiteList)},apply:function(a){null!=this.options.discountId&&-1!=this.options.discountId&&"promocode"==a.triggeringFieldName&&(nlapiSetFieldValue("discountitem",this.options.discountId,!0,!0),"virtualbrowser"==nlapiGetContext().getExecutionContext()&&Syncdiscountitem());this.setHasEligibleLine();if("promocode"!=a.triggeringFieldName&&this.flatDiscountIsConvertedToPercentage())this.calculateDiscountBasis();else if(this.isMinAmtMet()){if(this.options.discountId&&this.applyDiscount(),
"function"==typeof updateShippingCost&&this.options.shippingItem&&(this.options.isOrderLevel||this.hasEligibleLine)){if("promocode"==a.triggeringFieldName&&this.options.shippingCarrier){var c=this.options.shippingCarrier,b=new om.promotions.shipping.NLPromotionsShippingCost(this.options.shippingItem,0,0),d=nlapiGetFieldValue("shipcarrier"),n=nlapiGetFieldValue("shipmethod"),e=nlapiGetFieldValue("shippingcost"),k=nlapiGetFieldValue("handlingcost"),w=nlapiGetFieldValue("shippingcostoverridden");try{nlapiSetFieldValue("shipcarrier",
c,!0,!0),nlapiSetFieldValue("shipmethod",b.getShippingItemId(),!0,!0),updateShippingCost(b.getShippingCost()),updateHandlingCost(b.getHandlingCost()),synctotal(),nlapiSetFieldValue("shippingcostoverridden","F",!1,!0),y=!0}catch(N){nlapiSetFieldValue("shipcarrier",d,!0,!0),nlapiSetFieldValue("shipmethod",n,!0,!0),nlapiSetFieldValue("shippingcost",e,!0,!0),nlapiGetFieldValue("handlingcost")&&nlapiSetFieldValue("handlingcost",k,!0,!0),nlapiSetFieldValue("shippingcostoverridden",w,!1,!0)}}nlapiGetFieldValue("shipmethod")==
this.options.shippingItem&&(updateShippingCost(0),updateHandlingCost(0),om.promotions.webstore.setPromoShipCostList([{shipmeth:this.options.shippingItem,shipcost:0,handlingcost:0}]),y=!0);om.promotions.form.isUserInterface()||om.promotions.webstore.isValidWebstoreShippingMethod(a.shippingItems,this.options.shippingItem)||this.setError("NO_APPLICABLE_SHIPPING_METHOD_FOUND",[])}}else-1!=this.options.discountId&&nlapiSetFieldValue("discountrate","",!0,!0);this.error&&nlapiSetFieldValue("promocodeerror",
JSON.stringify(this.error),!0,!0)}}),G=function(){G.avoidValidateIncompatiblePromotions=!0;var a=nlapiGetCurrentLineItemValue("promotions","promocode"),c=1;for(nlapiCommitLineItem("promotions");1!=nlapiGetLineItemCount("promotions");)nlapiGetLineItemValue("promotions","promocode",c)!=a?nlapiRemoveLineItem("promotions",c):c=2;1==c&&nlapiCommitLineItem("promotions");G.avoidValidateIncompatiblePromotions=!1},K=function(a){if(0==a.length)return 0;var c=om.promotions.items.getItemLines();if(0==c.length)return 0;
a=om.promotions.form.collectDataForLegacyEngine(a,c);c=om.promotions.engine.runLegacy(a);var b=0,d;for(d in c)if(c.hasOwnProperty(d)){var n=c[d];0<n.lineDiscounts.length&&(b+=n.getLineDiscountAmount(a.itemLines));n.legacyPromotionOutput&&(b+=n.legacyPromotionOutput.getDiscountAmount());n.orderDiscount&&(b+=n.orderDiscount.getDiscountAmount())}return b},L={errors:{},addTranslation:function(a){for(var c in a)a.hasOwnProperty(c)&&(this.errors[c]=a[c])},get:function(a){return this.errors[a]}},z={error:{WHEN_THE_TRANSACTION_HAS_MULTIPLE_SHIPPING_ROUTE_ON_PROMOTION_WITH_SHIPPING_IMPACT_IS_NOT_ALLOWED_AND_WILL_BE_REMOVED:"When the transaction has Multiple Shipping Route on, promotion with shipping impact is not allowed, and will be removed.",
WHEN_MULTIPLE_SHIPPING_ROUTES_ARE_ACTIVATED_ON_A_TRANSACTION_PROMOTIONS_WITH_SHIPPING_IMPACT_ARE_NOT_SUPPORTED_AND_ARE_NOT_TAKEN_INTO_CONSIDERATION:"When Multiple Shipping Routes are activated on a transaction, promotions with shipping impact are not supported and are not taken into consideration.",A_COUPON_CODE_CAN_ONLY_BE_ADDED_ONCE:"A coupon code can only be added once",THIS_COUPON_CODE_REFERS_TO_A_PROMOTION_1_THIS_PROMOTION_HAS_BEEN_ALREADY_ADDED__A_PROMOTION_CAN_ONLY_BE_ADDED_ONCE__PLEASE_USE_ANOTHER_COUPON_CODE:"This coupon code refers to a promotion {1}.  This promotion has been already added.  A promotion can only be added once.  Please use another coupon code.",
THE_PROMOTIONS_YOU_ARE_TRYING_TO_APPLY_CANNOT_BE_COMBINED:"The promotions you are trying to apply cannot be combined.",THE_METHOD_DOES_NOT_HAVE_A_BEGINNING_FOR_TRACKING_THE_TIME_OR_IS_BEING_ENDED_WHEN_THERE_IS_INNER_METHOD_OPENED:"The method does not have a beginning for tracking the time or is being ended when there is inner method opened."},heading:{CONFIRMATION:"Confirmation"},addTranslation:function(a,c){for(var b in c)c.hasOwnProperty(b)&&(this[a][b]=c[b])}};return{machineAdapter:v.machineAdapter,
promotionEngineController:B,promoLanguages:z,pageInit_applyPromo:function(){nlapiGetFieldValue("promocode")!=nlapiGetFieldValue("persistedpromocode")&&"T"!=nlapiGetFieldValue("promotionapplied")&&f();h();"T"!==nlapiGetFieldValue("islegacypromo")||om.promotions.isPrinting()||om.promotions.runPromotionEngine("pageInit")},applyPromo:function(b,f){f.begin("applyPromo");f.addToContext({transactionId:nlapiGetRecordId()?nlapiGetRecordId():"-1"});if("T"===nlapiGetFieldValue("disablepromotion")||k)f.addToContext({"applyPromo.reason":"Not calling the engine because is disabled"});
else{q===b&&om.promotions.form.freegift.updateFreeGiftsAddedForEligibleFreeGiftPromotions();if(d()&&om.promotions.freegifts.resumingmechanism.shouldResumeMechanismRun()){if(om.promotions.freegifts.resumingmechanism.shouldResumeMechanismContinue(b)){f.addToContext({"applyPromo.reason":"Not calling the engine because adding free gifts or its discounts"});f.end("applyPromo");return}if(nlapiGetCurrentLineItemValue(e,n)&&nlapiGetCurrentLineItemIndex(e,n)==nlapiGetLineItemCount(e)){var g=promotions.getIsPromotionEngineDisabled();
promotions.setIsPromotionEngineDisabled(!0);nlapiSelectLineItem(e,nlapiGetLineItemCount(e));nlapiCancelLineItem(e);promotions.setIsPromotionEngineDisabled(g)}om.promotions.freegifts.resumingmechanism.rejectAllFreeGifts();f.addToContext({"applyPromo.resumingMechanism":"Attempting to reject free gifts"})}if(nlapiGetFieldValue("id")&&"T"==nlapiGetContext().getPreference("DO_NOT_CALCULATE_PROMOTIONS_ON_EDIT"))om.promotions.form.isUserInterface()&&"undefined"!==typeof disableCalculatePromotionBtn&&disableCalculatePromotionBtn(),
f.addToContext({"applyPromo.reason":"Preference DO_NOT_CALCULATE_PROMOTIONS_ON_EDIT is set to true"});else{if("undefined"!=typeof om.promotions.autoapply)try{om.promotions.autoapply.validateAutoApplyCannotBeCheckedWhenNotUsingNewEngine(!0)||f.addToContext({"applyPromo.userError":"The Automatically Apply Promotions box cannot be checked when a legacy promotion is added to the transaction"})}catch(H){throw f.addToContext({"applyPromo.userError":"The Automatically Apply Promotions box cannot be checked when a legacy promotion is added to the transaction"}),
f.setType(om.promotions.logger.MESSAGE_TYPE.ERROR),f.end("applyPromo"),H;}k=!0;h();om.promotions.logger.promotionsLogger.log("applyPromo trigger",b);NS.form.setInited(!0);u=null;f.addToContext({"applyPromo.isTransactionInDynamicDeferredMode":om.promotions.isTransactionInDynamicDeferredMode(),"applyPromo.isUserInterface":om.promotions.form.isUserInterface(),"applyPromo.isVirtualBrowser":om.promotions.form.isVirtualBrowser(),"applyPromo.isMultiShippingRoute":om.promotions.shipping.isMultiShippingRoute(),
"applyPromo.recordType":nlapiGetRecordType()});try{if(d()){l&&om.promotions.shipping.isMultiShippingRoute()&&("shippingCostCalculated"===b||"shippingGroupsCleared"===b?om.promotions.shipping.updateShippingGroupsRestoreValues():om.promotions.shipping.areShippingGroupsRestoreValuesNotValidBecauseOfEditingSavedTransaction()&&"shippingGroupLineCommit"!==b&&getShippingItemRate());om.promotions.form.setTriggeringEvent(b);f.begin("runNewEngineIfNeeded");if(c(f)){g=null;var m=!0;if(om.promotions.engine.isInResolvingConflictMode())f.addToContext({"applyPromo.reason":"Not calling the engine because resolving conflictive mode"});
else{"T"===nlapiGetFieldValue("doshippingrecalc")&&(f.addToContext({"applyPromo.totalling_Machine_Recalc":"Calling Totalling Machine Recalc from Promotions Engine"}),Totalling_Machine_Recalc());var w=om.promotions.form.collectData(),t="T"==nlapiGetFieldValue(x)&&0<nlapiGetLineItemCount(e);g=om.promotions.engine.run(w,t);m=1===g.promotionsCombinations.length&&!g.conflictivePromotionName;f.setType(om.promotions.logger.MESSAGE_TYPE.CALL);f.addToContext({"applyPromo.promoEngineOutput":JSON.stringify(g.promotionsCombinations),
"applyPromo.hasConflicts":!m});om.promotions.form.setFieldAutoApplyPromoAssociatedMessageDisplay(1==g.unknownShippingCostPreventsBestOffer);g.conflictivePromotionName&&nlapiRemoveLineItem("promotions",om.promotions.form.getLastAddedPromotionIndex())}if(m)om.promotions.suitepromotionmanager.processNewEngineOutput(om.promotions.engine.getLegacyPromotionEngineOutput());else if(g.conflictivePromotionName){var r={conflictivePromotionName:g.conflictivePromotionName,conflictivePromotionCombinationType:g.conflictivePromotionCombinationType};
om.promotions.window.openWithConflictiveItemExclusivePromotion(r,z.heading.CONFIRMATION)}else r=om.promotions.form.collectPopUpContextData(g),om.promotions.window.openWithConflictiveOrderOrShippingPromotion(r,z.heading.CONFIRMATION);var G=m;f.end("runNewEngineIfNeeded");var I=G}else f.addToContext({"applyPromo.reason":"Not running new engine","applyPromo.shouldNewEngineRun":!1}),f.end("runNewEngineIfNeeded"),I=!0;I&&("T"==nlapiGetFieldValue("promotionapplied")&&(B.unapplyPromoOutput(b),nlapiSetFieldValue("promotionapplied",
"F")),B.execute(b,f),nlapiSetFieldValue("promotionapplied","T"))}else f.addToContext({"applyPromo.reason":"shouldRunPromotionEngine is false","applyPromo.islegacypromo":nlapiGetFieldValue("islegacypromo"),"applyPromo.iseditbilledtransactionwithpromotion":nlapiGetFieldValue("iseditbilledtransactionwithpromotion"),"applyPromo.istransformedbill":nlapiGetFieldValue("istransformedbill"),"applyPromo.isTransformedTransactionAllowedToAddPromotions":a(),"applyPromo.entity":nlapiGetFieldValue("entity"),"applyPromo.checkTranType":p()}),
synctotal();om.promotions.form.isUserInterface()&&"undefined"!==typeof disableCalculatePromotionBtn&&disableCalculatePromotionBtn()}finally{om.promotions.logger.promotionsLogger.dump(),k=!1,om.promotions.form.freegift.updateFreeGiftsAdded()}om.promotions.freegifts.resumingmechanism.shouldResumeMechanismRun()&&om.promotions.freegifts.resumingmechanism.isResumingFreeGifts()&&q!==b&&om.promotions.freegifts.resumingmechanism.addFreeGift()}}f.end("applyPromo")},recalc_applyPromo:function(a,c){"item"!==
a&&l||"insert"===c||!om.promotions.items.isALineBeingAddedOrEditedOnTheItemMachine()&&!om.promotions.shipping.getExecutePromotionEngineWhenShippingIsRecalculated()&&"returnauthorization"!==nlapiGetRecordType()&&om.promotions.shipping.hasShippingRates()||k||"T"===nlapiGetFieldValue("disablepromotionrecalc")||(om.promotions.runPromotionEngine("itemMachineRecalc"),om.promotions.shipping.setExecutePromotionEngineWhenShippingIsRecalculated(!1),"T"!==nlapiGetFieldValue("islegacypromo")&&om.promotions.form.isUserInterface()&&
nlapiGetFieldValue("promocode")&&"undefined"!==typeof enableCalculatePromotionBtn&&enableCalculatePromotionBtn())},clearIncompatiblePromotions:G,isTransformedTransactionAllowedToAddPromotions:a,addMultipleItemCallback:function(a,c){if(l){var b=splitIntoRows(a);a=v.machineAdapter.getMachineInterface(e);for(b=b.length;0<b;b--){var d=c+b-1,n=a.recordData(d);a.lineAdded(d,n)}om.promotions.runPromotionEngine("addMultipleItemCallback")}},addErrorTranslation:function(a){L.addTranslation(a)},addTranslation:function(a,
c){z.addTranslation(a,c)},setIsTransactionInStackableMode:function(a){l=a},setIsShipMethodOverridden:function(a){A=a},setIsPromotionEngineDisabled:function(a){k=a},setIsDiscountSetByUser:function(a){t=a},setAllowedTransactions:function(a){C=a},getErrorTranslation:function(a){return L.errors[a]},getIsPromotionEngineDisabled:function(){return k},getLegacyPromoEngine:function(){return u},isTransactionInStackableMode:function(){return l},canHaveStackableHasNotBeenModifiedValidation:function(a){var c=
"T"===nlapiGetFieldValue("canhavestackable");if(a.isTransactionInCanHaveStackablePromotionsMode!=c){a.resetValue&&nlapiSetFieldValue("canhavestackable",a.isTransactionInCanHaveStackablePromotionsMode?"T":"F",!1);if(a.showAlertInsteadOfException)return alert(z.error.ATTEMPT_TO_CHANGE_THE_FIELD_CAN_HAVE_STACKABLE_PROMOTIONS_ONLY_SETTABLE_BY_CREATION_PARAMETER),!1;throw nlapiCreateError("ATTEMPT_TO_CHANGE_THE_FIELD_CAN_HAVE_STACKABLE_PROMOTIONS_ONLY_SETTABLE_BY_CREATION_PARAMETER",z.error.ATTEMPT_TO_CHANGE_THE_FIELD_CAN_HAVE_STACKABLE_PROMOTIONS_ONLY_SETTABLE_BY_CREATION_PARAMETER,
!0);}return!0},shouldNewEngineRun:c,shouldRunPromotionEngine:d,promocodeChanged:f,couponcodeChanged:function(){""==nlapiGetFieldValue("couponcode")&&f("couponcode")},stackableCouponcodeCodeChanged:function(){om.promotions.form.isUserInterface()&&(""==nlapiGetCurrentLineItemValue("promotions","promocode")&&(nlapiSetCurrentLineItemValue("promotions","discount","",!1),nlapiSetCurrentLineItemValue("promotions","ratedisplay","",!1)),D())},stackablePromocodeCodeChanged:function(a){var c=om.promotions.form.isUserInterface();
"couponcode"!=a&&(nlapiSetCurrentLineItemValue("promotions","couponcode",nlapiGetCurrentLineItemValue("promotions","muccpromocodeinstance"),!1),c&&""==nlapiGetCurrentLineItemValue("promotions","couponcode")&&nlapiSetCurrentLineItemText("promotions","couponcode","",!1));c&&D()},onUpdateBodyCouponCode:function(){if("T"==nlapiGetFieldValue("canhavestackable")&&""!=nlapiGetFieldValue("couponcode"))throw nlapiCreateError("THE_FIELDS_PROMOCODE_AND_COUPONCODE_CANNOT_BE_SET_WHEN_THE_FIELD_CAN_HAVE_SUITEPROMOTIONS_IS_CHECKED",
z.error.THE_FIELDS_PROMOCODE_AND_COUPONCODE_CANNOT_BE_SET_WHEN_THE_FIELD_CAN_HAVE_SUITEPROMOTIONS_IS_CHECKED,!0);var a=E("promotions","couponcode",1);"F"==nlapiGetFieldValue("canhavestackable")&&(nlapiGetFieldValue("couponcode")!=a?(1<=nlapiGetLineItemCount("promotions")&&nlapiRemoveLineItem("promotions",1),""!=nlapiGetFieldValue("couponcode")&&(nlapiSetCurrentLineItemValue("promotions","couponcode",nlapiGetFieldValue("couponcode"),!0,!0),nlapiCommitLineItem("promotions"),nlapiSetFieldValue("promocode",
nlapiGetLineItemValue("promotions","promocode",1),!1,!0))):om.promotions.webstore.isWebStoreRequest()&&om.promotions.runPromotionEngine("promocode"))},onUpdateBodyPromoCode:function(){if("T"==nlapiGetFieldValue("canhavestackable")&&""!=nlapiGetFieldValue("promocode"))throw nlapiCreateError("THE_FIELDS_PROMOCODE_AND_COUPONCODE_CANNOT_BE_SET_WHEN_THE_FIELD_CAN_HAVE_SUITEPROMOTIONS_IS_CHECKED",z.error.THE_FIELDS_PROMOCODE_AND_COUPONCODE_CANNOT_BE_SET_WHEN_THE_FIELD_CAN_HAVE_SUITEPROMOTIONS_IS_CHECKED,
!0);var a=E("promotions","promocode",1);"F"==nlapiGetFieldValue("canhavestackable")&&nlapiGetFieldValue("promocode")!=a&&(1<=nlapiGetLineItemCount("promotions")&&nlapiRemoveLineItem("promotions",1),""!=nlapiGetFieldValue("promocode")&&(nlapiSetCurrentLineItemValue("promotions","promocode",nlapiGetFieldValue("promocode"),!0,!0),nlapiCommitLineItem("promotions"),nlapiSetFieldValue("couponcode",nlapiGetLineItemValue("promotions","couponcode",1),!1,!0)))},promotionsMachineLineCommit:function(a){"undefined"!==
typeof om.promotions.autoapply&&om.utils.isValueDefined(nlapiGetFieldValue(x))&&1===nlapiGetLineItemCount("promotions")&&om.promotions.autoapply.updateAutoApplyAndBestOfferCheckboxEnablement();om.promotions.form.setPromotionIds();om.promotions.form.freegift.syncFreeGiftPromotionColumn();om.promotions.runPromotionEngine("promoMachineChanged")},promotionsMachineDeleteLine:function(){"undefined"!==typeof om.promotions.autoapply&&om.utils.isValueDefined(nlapiGetFieldValue(x))&&0===nlapiGetLineItemCount("promotions")&&
om.promotions.autoapply.updateAutoApplyAndBestOfferCheckboxEnablement();om.promotions.form.setPromotionIds();om.promotions.form.freegift.syncFreeGiftPromotionColumn();om.promotions.runPromotionEngine("promoMachineLineDeleted")},promotionsMachineValidateLine:function(){om.promotions.isNewPromotionEngineEnabled()&&"F"===nlapiGetCurrentLineItemValue("promotions","isnewpromotiontype")&&om.promotions.form.setPromotionMachineCurrentLineDiscountAmountsForOldEngine();om.promotions.form.setLastAddedPromotionIndex(nlapiGetCurrentLineItemIndex("promotions"));
return g()},promotionsMachineValidateInsert:function(){return!0}}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.engine=function(){function b(c){a=d(p.promotionsCombinations[c].legacyPromotionEngineOutput);m=p.promotionsCombinations[c].shippingDiscountIsKnown}function d(a){var c={},b;for(b in a)a.hasOwnProperty(b)&&(c[b]=new h(JSON.parse(a[b])));return c}var a=null,c=!1,m=!1,p,h=new om.promotions.common.NLClass({initialize:function(a){function c(){this.lineDiscounts=[];a.lineDiscounts&&0<a.lineDiscounts.length&&(a.lineDiscounts.forEach(function(a){this.addLineDiscount(a.lineNum,a.isPercent,a.discountRate,
a.discountAmount)},this),d.call(this))}function b(){this.freeGifts=[];a.freeGifts&&0<a.freeGifts.length&&a.freeGifts.forEach(function(a){this.addFreeGift(a.lineNumber,a.itemCustomerWillGet,a.freeGiftPromotion,a.status,a.quantity)},this)}function d(){this.lineDiscounts.sort(function(a,c){return a.lineNum-c.lineNum})}function e(){this.updatedShippingItems=[];a.updatedShippingCosts&&0<a.updatedShippingCosts.length&&a.updatedShippingCosts.forEach(function(a){this.addUpdatedShippingCost(new om.promotions.shipping.NLPromotionsShippingCost(a.shippingItemId,
a.shippingCost,a.handlingCost))},this)}function n(){this.updatedShippingGroupItems=[];a.updatedShippingGroupCosts&&0<a.updatedShippingGroupCosts.length&&a.updatedShippingGroupCosts.forEach(function(a){this.addUpdatedShippingGroupCost(new om.promotions.shipping.NLPromotionsShippingGroupCost(a.shippingGroupLineNumber,a.shippingCost,a.handlingCost))},this)}a&&(this.discountItemId=a.discountItemId,this.hasFreeShippingMethod=a.hasFreeShippingMethod,this.errorCode=a.error,this.purchaseDiscount=a.purchaseDiscount,
this.eligibleFreeGifts=a.eligibleFreeGifts,this.freeGiftsAdded=a.freeGiftsAdded,a.legacyPromotionOutput&&(this.legacyPromotionOutput=new f(JSON.parse(a.legacyPromotionOutput))),a.promotionalShipping?(this.promotionalShippingMethod=a.promotionalShipping.promotionalShippingMethod,this.promotionalShippingCarrier=a.promotionalShipping.promotionalShippingCarrier,this.promotionalShipping=a.promotionalShipping):this.promotionalShippingCarrier=this.promotionalShippingMethod=-1,this.setExcludeFromRateRequest(a.excludeFromRateRequest?
JSON.parse(a.excludeFromRateRequest):{shippingItemIds:[],lineNums:[]}),a.orderDiscount&&this.setOrderDiscount(a.orderDiscount.isPercent,a.orderDiscount.discountRate,a.orderDiscount.discountAmount),c.call(this),b.call(this),e.call(this),n.call(this),a.applicability&&(this.applicability=new x(a.applicability)))},isItemSpecificFreeShipping:function(){return this.excludeFromRateRequest&&this.excludeFromRateRequest.shippingItemIds&&0<this.excludeFromRateRequest.shippingItemIds.length},setOrderDiscount:function(a,
c,b){this.orderDiscount=new g(a,c,b)},addLineDiscount:function(a,c,b,d){this.lineDiscounts.push(new v(a,c,b,d))},getLineDiscounts:function(){return this.lineDiscounts},addFreeGift:function(a,c,b,d,k){this.freeGifts.push(new e(a,c,b,d,k))},getExcludeFromRateRequest:function(){return this.excludeFromRateRequest},setExcludeFromRateRequest:function(a){return this.excludeFromRateRequest=a},updateShippingCost:function(a,c,b){},hasShippingImpact:function(){return this.legacyPromotionOutput?!!this.legacyPromotionOutput.shippingItem:
this.updatedShippingItems&&0<this.updatedShippingItems.length||this.updatedShippingGroupItems&&0<this.updatedShippingGroupItems.length||!!this.promotionalShippingMethod},addUpdatedShippingCost:function(a){this.updatedShippingItems.push(a)},getUpdatedShippingItems:function(){return this.updatedShippingItems},addUpdatedShippingGroupCost:function(a){this.updatedShippingGroupItems.push(a)},getUpdatedShippingGroupItems:function(){return this.updatedShippingGroupItems},getError:function(){return this.errorCode},
getLineDiscountAmount:function(a){var c=0;if(0<this.lineDiscounts.length)for(var b=this.lineDiscounts,d=0;d<b.length;d++){var e=b[d],f=this.getItemLine(a,e.lineNum);c=e.isPercent?c+.01*parseFloat(e.discountRate)*f.amount:c+e.discountRate}return c},getItemLine:function(a,c){for(var b=0;b<a.length;b++)if(a[b].lineNum===c)return a[b]}}),f=new om.promotions.common.NLClass({initialize:function(a){this.id=a.id;this.minAmounts=a.minAmounts;this.isWhiteList=a.isWhiteList;this.items=a.items;this.isPercent=
a.isPercent;this.shippingCarrier=a.shippingCarrier;this.shippingItem=a.shippingItem;this.isOrderLevel=a.isOrderLevel;this.discountRate=a.discountRate;this.discountId=a.discountId;this.promoCode=a.promoCode},getDiscountAmount:function(){var a=0;if(this.isPercent){var c=om.promotions.items.calculateItemCouponTotal(this.items,this.isWhiteList);a+=.01*parseFloat(this.discountRate)*c}this.isPercent||(a+=parseFloat(this.discountRate));return a}}),g=new om.promotions.common.NLClass({initialize:function(a,
c,b){this.isPercent=a;this.discountRate=c;this.discountAmount=b},isPercent:function(){return this.isPercent},setIsPercent:function(a){this.isPercent=a},getDiscountRate:function(){return this.discountRate},setDiscountRate:function(a){this.discountRate=a},getDiscountAmount:function(){var a=0;if(this.isPercent){var c=om.promotions.items.calculateItemCouponTotal();a+=.01*parseFloat(this.discountRate)*c}this.isPercent||(a+=parseFloat(this.discountRate));return a}}),v=new om.promotions.common.NLClass({initialize:function(a,
c,b,d){this.lineNum=a;this.isPercent=c;this.discountRate=b;this.discountAmount=d},getLineNum:function(){return this.lineNum},isPercent:function(){return this.isPercent},getDiscountRate:function(){return this.discountRate}}),x=new om.promotions.common.NLClass({initialize:function(a){this.status=a.status;this.reason=a.reason;this.mode=a.mode},getStatus:function(){return this.status},getReason:function(){return this.reason},getMode:function(){return this.mode}}),e=new om.promotions.common.NLClass({initialize:function(a,
c,b,d,e){this.lineNumber=a;this.itemCustomerWillGet=c;this.freeGiftPromotion=b;this.status=d;this.quantity=e},getlineNumber:function(){return this.lineNumber},getItemCustomerWillGet:function(){return this.itemCustomerWillGet},getFreeGiftPromotion:function(){return this.freeGiftPromotion},getStatus:function(){return this.status},getQuantity:function(){return this.quantity}});return{run:function(a,c){p=nlapiServerCall("/app/accounting/transactions/promotions/engine/promotionengine.nl","run",[JSON.stringify(a),
c]);b(0);return p},runLegacy:function(a,c){c&&(c.begin("runLegacy"),c.setType(om.promotions.logger.MESSAGE_TYPE.CALL));om.promotions.logger.promotionsLogger.log("\n::::::: Legacy engine input (runLegacy)",a);a=nlapiServerCall("/app/crm/sales/plugin/promotionhandler.nl","runPromotionEngine",[a.toParams()]);om.promotions.logger.promotionsLogger.logLegacyPromotionEngineOutput("Legacy engine output (runLegacy)",a);c&&c.end("runLegacy");return d(a)},isInResolvingConflictMode:function(){return c},setInResolvingConflictMode:function(a){c=
a},setLegacyPromotionEngineOutput:b,getLegacyPromotionEngineOutput:function(){return a},getShippingDiscountIsKnown:function(){return m}}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.form=function(){function b(a){if(p())for(var c=0;c<a.length;c++)a[c].shippingdiscount===NS.Translations.dictionary["NLFormlabelContext.PENDING_SHIPPING_COST_CALCULATION"]&&(a[c].shippingdiscount="PENDING_SHIPPING_COST_CALCULATION");return a}function d(){nlapiGetCurrentLineItemValue(e,"promocode")&&nlapiCancelLineItem(e)}function a(a){return isNaN(a)?a:format_currency(a)}function c(a,c){nlapiSetCurrentLineItemValue(e,n,a);nlapiSetCurrentLineItemValue(e,"shippingdiscount",c)}function m(c){c?
c.promotionalShipping?(c=c.promotionalShipping,c=null!=c.discountAmount?-1*c.discountAmount:p()?NS.Translations.dictionary["NLFormlabelContext.PENDING_SHIPPING_COST_CALCULATION"]:"PENDING_SHIPPING_COST_CALCULATION"):c=c.hasFreeShippingMethod?0:x:c=0;return a(c)}function p(){return"userinterface"===nlapiGetContext().getExecutionContext()}function h(){return"virtualbrowser"===nlapiGetContext().getExecutionContext()}function f(a){for(var c=[],b=nlapiGetLineItemCount(e),d=1;d<=b;d++)if(!a||nlapiGetCurrentLineItemIndex(e)!=
d){var f=g(d,nlapiGetLineItemValue(e,"promocode",d),nlapiGetLineItemValue(e,"couponcode",d),nlapiGetLineItemValue(e,"applicabilitymode",d));""!=f.promotion&&c.push(f)}return c}function g(a,c,b,d){return{machineOrdinal:a,promotion:c,couponcode:b,applicabilityMode:d}}var v=om.promotions.common,x=v.PROMOTION_DOES_NOT_APPLY_SYMBOL,e=v.PROMOTIONS_MACHINE.NAME,n=v.PROMOTIONS_MACHINE.PURCHASE_DISCOUNT,q,u,l=!1;return{addPromotionsSettingAppliedDiscounts:function(b,d){for(var f=0;f<b.length;f++){var g=b[f];
nlapiSelectNewLineItem(e);nlapiSetCurrentLineItemValue(e,"promocode",g,!0,!0);g=d[g];c(a(g?g.hasFreeShippingMethod?x:-1*g.purchaseDiscount:0),m(g));om.promotions.suitepromotionmanager.updateApplicability(g);om.promotions.form.freegift.updatePromotionMachineFreeGiftsColumnsFromOuput(g);nlapiCommitLineItem(e)}},collectData:function(){return{transactionId:nlapiGetFieldValue("id"),currency:nlapiGetFieldValue("currency"),currencyprecision:nlapiGetFieldValue("currencyprecision"),shipmethod:nlapiGetFieldValue("shipmethod"),
shippingcost:isNaN(nlapiGetFieldValue("shippingcost"))?null:nlapiGetFieldValue("shippingcost"),handlingcost:nlapiGetFieldValue("handlingcost"),shippinggroups:"T"===nlapiGetFieldValue("ismultishipto")?om.promotions.shipping.collectShippingGroups():[],entity:nlapiGetFieldValue("entity"),trandate:nlapiGetFieldValue("trandate"),subsidiary:nlapiGetFieldValue("subsidiary"),customform:nlapiGetFieldValue("customform"),website:nlapiGetFieldValue("website"),location:nlapiGetFieldValue("location"),ismultishipto:nlapiGetFieldValue("ismultishipto"),
discountispercent:-1!=nlapiGetFieldValue("discountrate").indexOf("%"),discountrate:""===nlapiGetFieldValue("discountrate")?0:parseFloat(nlapiGetFieldValue("discountrate")),lastAddedPromotionIndex:q,promotions:b(om.utils.collectMachineData(e,"promocode shippingdiscount applicabilityreason applicabilitymode eligiblefreegifts freegiftsadded".split(" "),!1)),items:om.utils.collectMachineData("item","itemtype item amount quantity custreferralcode freegiftpromotion".split(" "),!0,function(a){return a.item&&
a.quantity}),shippingItems:""!==nlapiGetFieldValue("shipcostlist")?JSON.parse(nlapiGetFieldValue("shipcostlist")):[],triggeringEvent:u}},collectDataForLegacyEngine:function(a,c,b){return{isVBMode:h(),promotions:a,currencyId:nlapiGetFieldValue("currency"),itemLines:c,shippingItems:om.promotions.shipping.getShippingItems(),itemsAmount:om.promotions.items.getItemsAmount(c),customerId:nlapiGetFieldValue("entity"),transactionDate:nlapiGetFieldValue("trandate"),selectedShippingItemId:nlapiGetFieldValue("shipmethod"),
subsidiaryId:nlapiGetFieldValue("subsidiary"),customFormId:nlapiGetFieldValue("customform"),siteId:nlapiGetFieldValue("website")||"",locationId:nlapiGetFieldValue("location"),isMultiShipping:om.promotions.shipping.isMultiShippingRoute(),canHaveStackablePromotions:"T"==nlapiGetFieldValue("canhavestackable"),triggeringFieldName:b,toParams:function(){return{isVBMode:this.isVBMode?"T":"F",promotions:JSON.stringify(this.promotions),currencyId:this.currencyId,itemLines:JSON.stringify(this.itemLines),shippingItems:JSON.stringify(this.shippingItems),
itemsAmount:this.itemsAmount.toString(),customerId:this.customerId,transactionDate:this.transactionDate,selectedShippingItemId:this.selectedShippingItemId,subsidiaryId:this.subsidiaryId,customFormId:this.customFormId,siteId:this.siteId,locationId:this.locationId,isMultiShipping:this.isMultiShipping,canHaveStackablePromotions:this.canHaveStackablePromotions}}}},collectPopUpContextData:function(a){var c=a.promotionsCombinations[0];a=a.promotionsCombinations[1];return{nonMultiShippingShippingMethodId:nlapiGetFieldValue("shipmethod"),
toBeAppliedPromotionId:nlapiGetLineItemValue(e,"promocode",q),currencyPrecision:nlapiGetFieldValue("currencyprecision"),appliedHasShippingImpact:c.hasShippingImpact,appliedShippingDiscountIsKnown:c.shippingDiscountIsKnown,appliedPurchaseDiscount:c.appliedPurchaseDiscount,appliedShippingDiscount:c.appliedShippingDiscount,toBeAppliedHasShippingImpact:a.hasShippingImpact,toBeAppliedShippingDiscountIsKnown:a.shippingDiscountIsKnown,toBeAppliedPurchaseDiscount:a.appliedPurchaseDiscount,toBeAppliedShippingDiscount:a.appliedShippingDiscount}},
getCurrentStackablePromotionsInTransaction:function(){var a=[],c=g(null,nlapiGetCurrentLineItemValue(e,"promocode"),nlapiGetCurrentLineItemValue(e,"couponcode"),nlapiGetCurrentLineItemValue(e,"applicabilitymode"));""!=c.promotion&&a.push(c);return a},getPromotionsInTransaction:function(){var a=[];promotions.isTransactionInStackableMode()?a=f():nlapiGetFieldValue("promocode")&&a.push({promotion:nlapiGetFieldValue("promocode"),couponcode:nlapiGetFieldValue("couponcode")});return a},getStackablePromotionsInTransaction:f,
getShippingGroupHandlingCost:function(a){return nlapiGetLineItemValue("shipgroup","handlingrate",a)},getShippingGroupShippingCost:function(a){return nlapiGetLineItemValue("shipgroup","shippingrate",a)},filterOnToBeAddedPromotions:function(a){var c=om.utils.collectSingleMachineDataColumn(e,"promocode");return om.utils.complementCollection(a,om.utils.convertStringArrayToIntArray(c))},isMachineAvailable:function(a){try{return null!=nlapiGetSubList(a)}catch(t){return!1}},isShippingGroupCostBeingUpdated:function(){return l},
isUserInterface:p,isVirtualBrowser:h,setFieldAutoApplyPromoAssociatedMessageDisplay:function(a){nlapiSetFieldDisplay("automaticallyapplypromotionsassociatedmessage",a)},setPromotionMachineCurrentLineDiscountAmountsForOldEngine:function(){var a=p()?NS.Translations.dictionary["NLFormlabelContext.NOT_AVAILABLE"]:"";c(a,a);a=p()?NS.Translations.dictionary["NLFormlabelContext.NOT_AVAILABLE"]:"N/A";nlapiSetCurrentLineItemValue(e,om.promotions.common.freegift.CONSTANTS.ELIGIBLE_FREE_GIFTS,a);nlapiSetCurrentLineItemValue(e,
om.promotions.common.freegift.CONSTANTS.FREE_GIFTS_ADDED,a)},updatePromotionsDiscountAmount:function(b,f){d();for(var g=nlapiGetLineItemCount(e),h=1;h<=g;h++){var k=nlapiGetLineItemValue(e,"promocode",h);if(-1===b.indexOf(parseInt(k))){var n=h,p=(k=f[k])&&k.applicability&&k.applicability.getStatus()===om.promotions.common.STATUS.NOT_APPLIED,l=p?x:a(k?k.hasFreeShippingMethod?x:-1*k.purchaseDiscount:0);p=p?x:m(k);nlapiSelectLineItem(e,n);c(l,p);om.promotions.suitepromotionmanager.updateApplicability(k);
om.promotions.form.freegift.updatePromotionMachineFreeGiftsColumnsFromOuput(k);nlapiCommitLineItem(e)}}},updateShippingGroupCost:function(a,c,b){l=!0;nlapiSelectLineItem("shipgroup",a);nlapiSetCurrentLineItemValue("shipgroup","shippingrate",c);nlapiSetCurrentLineItemValue("shipgroup","handlingrate",b);nlapiCommitLineItem("shipgroup");l=!1},setLastAddedPromotionIndex:function(a){q=a},getLastAddedPromotionIndex:function(){return q},setTriggeringEvent:function(a){u=a},setPromotionIds:function(){for(var a=
[],c=1;c<=nlapiGetLineItemCount(e);c++)a.push(nlapiGetLineItemValue(e,"promocode",c));nlapiSetFieldValues("promotionids",a,p())},cancelLineItem:d}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.items=function(){function b(a,c,b){for(var d in a)a.hasOwnProperty(d)&&a[d].lineDiscounts.forEach(function(a){a.lineNum>c&&(a.lineNum+=b)});A=!0}function d(a){a=nlapiGetLineItemValue(g,k,a);var c=-1!==a.indexOf("%");return{floatValue:parseFloat(a),isPercent:c}}function a(a,c,b,d){a>nlapiGetLineItemCount(g)?nlapiSelectNewLineItem(g):nlapiInsertLineItem(g,a);nlapiSetCurrentLineItemValue(g,q,c,!0,!0);--a;c=r;for(var e=0;e<c.length;e++)nlapiGetLineItemField(g,c[e])&&nlapiSetCurrentLineItemValue(g,
c[e],nlapiGetLineItemValue(g,c[e],a),!0,!0);nlapiSetCurrentLineItemValue(g,k,b,!0,!0);nlapiSetCurrentLineItemValue(g,x,d,!0,!0);nlapiCommitLineItem(g)}function c(a){return nlapiGetLineItemValue(g,u,a)===e}function m(a){return c(a)&&""!==nlapiGetLineItemValue(g,x,a)}function p(a){return""!==a&&-1===om.promotions.common.indexOf(["Discount","Subtotal","EndGroup","Description","Group"],a)}function h(a,c,b){return!c||0===c.length||b&&0<=om.promotions.common.indexOf(c,a)||!b&&-1===om.promotions.common.indexOf(c,
a)}var f=om.promotions.common,g=f.ITEM_MACHINE.NAME,v=f.ITEM_MACHINE.AMOUNT,x=f.ITEM_MACHINE.CUSTREFERRALCODE,e=f.ITEM_MACHINE.DISCOUNT,n=f.freegift.CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION,q=f.ITEM_MACHINE.ITEM,u=f.ITEM_MACHINE.ITEMTYPE,l=f.ITEM_MACHINE.QUANTITY,k=f.ITEM_MACHINE.RATE,t=f.APPLY_PROMO_TRIGGER.EVENT_ITEM_MACHINE_RECALC,r="taxcode taxrate1 taxrate2 class department location".split(" "),y,C=!1,A=!1,D=!1;(function(){om.promotions.common.machineAdapter.getMachineInterface(g).lineAdded=
function(a){promotions.isTransactionInStackableMode()&&om.promotions.freegifts&&om.promotions.freegifts.resumingmechanism.shouldResumeMechanismRun()&&om.promotions.freegifts.resumingmechanism.shouldResumeMechanismContinue(t)&&om.promotions.freegifts.resumingmechanism.addFreeGift();D=!1};om.promotions.common.machineAdapter.getMachineInterface(g).lineDeleted=function(a){promotions.isTransactionInStackableMode()&&!C&&om.promotions.runPromotionEngine(t)};om.promotions.common.machineAdapter.getMachineInterface(g).recordData=
function(a){if(a)return{itemType:nlapiGetLineItemValue(g,u,a),quantity:nlapiGetLineItemValue(g,l,a),freegiftpromotion:nlapiGetLineItemValue(g,n,a)}};om.promotions.common.machineAdapter.getMachineInterface(g).validateLine=function(a){if(a)return D=!0,a=nlapiGetCurrentLineItemValue(g,q),f.isSuitePromotionsEnabledForThisTransaction()?(new FreeGiftValidator(a)).validateFreeGiftAddedToItemMachine():!0};om.promotions.common.machineAdapter.getMachineInterface(g).validateDelete=function(a,b){if(promotions.isTransactionInStackableMode()&&
!C&&p(b)){b=nlapiGetLineItemCount(g);var d=a+1;if(!(b<d)&&c(d)){C=!0;var e=promotions.getIsPromotionEngineDisabled();for(promotions.setIsPromotionEngineDisabled(!0);b>=d&&m(d);)nlapiRemoveLineItem(g,d);nlapiSelectLineItem(g,a);promotions.setIsPromotionEngineDisabled(e);C=!1}}}})();var E=new om.promotions.common.NLClass({initialize:function(a,c,b,d,e){this.lineNum=a;this.itemType=c;this.itemId=b;this.quantity=d;this.amount=e},getLineNum:function(){return this.lineNum},getItemType:function(){return this.itemType},
getItemId:function(){return this.itemId},getQuantity:function(){return this.quantity},getAmount:function(){return this.amount}});return{applyLineLevelDiscounts:function(d,e){var f=e.lineDiscounts,h=e.discountItemId;e=[];for(var k,n=0;n<f.length;n++){k=f[n];a:{var p=d;for(var l=k.lineNum+1;c(l);){if(m(l)&&nlapiGetLineItemValue(g,x,l)===p){p=!0;break a}l++}p=!1}p?A=!1:e.push({itemId:h,rate:format_rate(-k.discountRate,k.isPercent),lineNum:k.lineNum+1})}if(0<e.length)if(om.promotions.form.isUserInterface()){if(!(f=
y)){f=document.forms.main_form.itemfields.value.split(String.fromCharCode(1));h={};for(k=0;k<f.length;k++)h[f[k].toLowerCase()]=k;f=h}y=f;h=getFormAddItemURL([e[0].itemId],["1"])+"\x26aipromo\x3d"+d;f=0;try{var q=doGetWrongFieldVisibilities(h);var u=nlapiServerCall(h,"getAdjustedLineData",[JSON.stringify(q)])}catch(M){u=nlapiServerCall(h,"getLineData",[])}q=u.split(String.fromCharCode(1));for(h=0;h<e.length;h++){k=e[h];u=k.lineNum+f;q[y.custreferralcode]=d;q[y.rate]=k.rate;k=u-1;n=q;p=r;for(l=0;l<
p.length;l++){var t=p[l],v=nlapiGetLineItemField(g,t);v&&(n[y[t]]=nlapiGetLineItemValue(g,t,k),"select"===v.getType()&&(n[y[t+"_display"]]=nlapiGetLineItemValue(g,t+"_display",k)))}InsertItemData(q.join(String.fromCharCode(1)),u);b(promotions.promotionEngineController.getCurrentPromotionsOutput(),u-1,1);f+=1}synctotal(!0);nlapiSetFieldValue("doshippingrecalc","T",!1);writeLineArray(g)}else for(h=q=0;h<e.length;h++)u=e[h],f=u.lineNum+q,a(f,u.itemId,u.rate,d),b(promotions.promotionEngineController.getCurrentPromotionsOutput(),
f-1,1),q+=1;om.promotions.form.isUserInterface()||om.promotions.webstore.setItemLinePromoFields()},calculateItemCouponTotal:function(a,c){for(var b=null,d=nlapiGetLineItemCount(g),e=1;e<=d;e++){var f=nlapiGetLineItemValue(g,u,e);-1===om.promotions.common.indexOf(["Subtotal","EndGroup","Description","Group"],f)&&(f=getEncodedValue(g,e,q),h(f,a,c)&&(b+=parseFloat(nlapiGetLineItemValue(g,v,e).replace(/,/g,""))))}return b},canApplyTo:h,getItemLines:function(){for(var a=[],c=nlapiGetLineItemCount(g),b=
1;b<=c;b++){var d=b;var e=nlapiGetLineItemValue(g,u,d),f=nlapiGetLineItemValue(g,q,d),h=parseFloat(nlapiGetLineItemValue(g,v,d).replace(/,/g,"")),m=parseFloat(nlapiGetLineItemValue(g,l,d).replace(/,/g,""));d=new E(d,e,f,m,h);d.itemId&&a.push(d)}return a},getItemsAmount:function(a){for(var c=0,b=0;b<a.length;b++)om.promotions.items.isProperItemType(a[b].itemType)&&(c+=a[b].amount);return c},getPromoOutputLineNumbersWereAdjusted:function(){return A},isLineItemADiscount:c,isLineItemAPromotionDiscount:m,
isALineBeingAddedOrEditedOnTheItemMachine:function(){return D},isProperItemType:p,removePromotionLineItemDiscounts:function(a){for(var e=0,f=[],h=[],k=nlapiGetLineItemCount(g),n=1;n<=k;n++)if(m(n)){var l=nlapiGetLineItemValue(g,"custreferralcode",n);om.promotions.form.freegift.isFreeGiftPromotion(l)||h.push(n)}for(k=0;k<h.length;k++){l=n=h[k]-e;for(var q=a,t=nlapiGetLineItemValue(g,x,l),v=Object.keys(q),r=null,y=0;null!=v&&y<v.length&&null==r;y++){var B=v[y];if(t===B){r=q[B];var A;a:{for(A=l;0<A;A--)if(p(nlapiGetLineItemValue(g,
u,A)))break a;A=0}a:{var D=d(l);r=r.lineDiscounts;for(var H=0;H<r.length;H++){var E=r[H];if(A===E.lineNum&&D.floatValue===-E.getDiscountRate()&&E.isPercent===D.isPercent){r={lineNum:E.lineNum,promoId:B};break a}}r=null}}}l=r;if(!(q=null==l))a:{for(q=0;q<f.length;q++)if(l.lineNum===f[q].lineNum&&l.promoId===f[q].promoId){q=!0;break a}q=!1}if(q){l=a;C=!0;nlapiRemoveLineItem(g,n);C=!1;b(l,n,-1);a:{for(;1<n;)if(n--,!c(n)&&"Markup"!==nlapiGetLineItemValue(g,u,n))break a;n=null}null!=n&&om.promotions.webstore.clearItemLinePromoFields(n);
e+=1}else f.push(l)}0<e&&nlapiSelectNewLineItem(g)},adjustPromoOutputLineItemDiscountsLineNumbers:b,insertDiscountLine:a,parseRate:d}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.items.freegift=function(){function b(a,c,b){om.promotions.items.insertDiscountLine(b+1,c,format_rate(-100,!0),a);om.promotions.items.adjustPromoOutputLineItemDiscountsLineNumbers(promotions.promotionEngineController.getCurrentPromotionsOutput(),b,1)}function d(a,c,b){for(var d=a.length-1;0<=d&&a[d]>c;)a[d]+=b,d--}function a(a,c){return!a||0< !Object.keys(a).length?!1:a[c]}function c(c,b,d){if(!a(c,b))return!1;c=c[b];var e=c.freeGifts;return c.applicability&&c.applicability.status===
om.promotions.common.STATUS.APPLIED&&b===b&&0<Object.keys(e).length?e.every(function(a){return a.lineNumber!==d||0!==a.quantity}):!1}function m(a){return nlapiGetLineItemValue(h,v,a)===x?(nlapiRemoveLineItem(h,a),!0):!1}function p(a){a=nlapiGetLineItemValue(h,om.promotions.common.freegift.CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION,a);return""!==a&&null!==a}var h=om.promotions.common.ITEM_MACHINE.NAME,f=om.promotions.common.ITEM_MACHINE.ITEM,g=om.promotions.common.ITEM_MACHINE.QUANTITY,v=om.promotions.common.ITEM_MACHINE.ITEMTYPE,
x=om.promotions.common.ITEM_MACHINE.DISCOUNT;return{updateChangedFreeGifts:function(a){if(om.promotions.form.isUserInterface())for(var c=0;c<a.freeGifts.length;c++){var b=a.freeGifts[c];b.status===om.promotions.common.freegift.CONSTANTS.FREE_GIFT_STATUS_CHANGED&&0!==b.quantity&&(nlapiSelectLineItem(om.promotions.common.ITEM_MACHINE.NAME,b.lineNumber),nlapiSetCurrentLineItemValue(om.promotions.common.ITEM_MACHINE.NAME,g,b.quantity),nlapiCommitLineItem(om.promotions.common.ITEM_MACHINE.NAME))}},removeNotValidFreeGiftsAndDiscounts:function(f){for(var e=
[],g=[],u=nlapiGetLineItemCount(h),l=1;l<=u;l++)if(p(l))e.push(l);else if(om.promotions.items.isLineItemAPromotionDiscount(l)){var k=nlapiGetLineItemValue(h,om.promotions.common.ITEM_MACHINE.CUSTREFERRALCODE,l);if(om.promotions.form.freegift.isFreeGiftPromotion(k)){var t;if(t=1!==l)t=nlapiGetLineItemValue(h,om.promotions.common.freegift.CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION,l-1)===k;t||g.push(l)}}for(u=e.length-1;0<=u;u--)if(l=e[u],k=nlapiGetLineItemValue(om.promotions.common.ITEM_MACHINE.NAME,
om.promotions.common.freegift.CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION,l),c(f,k,l)){if(t=l+1,nlapiGetLineItemValue(h,v,t)===x?(t=om.promotions.items.parseRate(t),t=-100!==t.floatValue||!t.isPercent):t=!0,t){t=g;var r=f[k];nlapiGetLineItemValue(h,v,l+1)!==x?(b(k,r.discountItemId,l),d(t,l,1)):(m(l+1),b(k,r.discountItemId,l))}}else if(t=f,r=g,om.promotions.form.isUserInterface()||!a(t,k))k=l,nlapiRemoveLineItem(h,k),om.promotions.items.adjustPromoOutputLineItemDiscountsLineNumbers(promotions.promotionEngineController.getCurrentPromotionsOutput(),
k,-2),d(r,l,-2);for(f=g.length-1;0<=f;f--)e=g[f],m(e),om.promotions.items.adjustPromoOutputLineItemDiscountsLineNumbers(promotions.promotionEngineController.getCurrentPromotionsOutput(),e,-1)},addFreeGift:function(a){nlapiSelectNewLineItem(h);nlapiSetCurrentLineItemValue(h,f,a.itemCustomerWillGet,!0,!0);nlapiSetCurrentLineItemValue(h,g,a.quantity,!0,!0);nlapiSetCurrentLineItemValue(h,om.promotions.common.freegift.CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION,a.freeGiftPromotion,!1,!1);nlapiCommitLineItem(h)},
addFreeGiftDiscountLine:b,validateAllFreeGiftsInTransaction:function(){for(var a=1;a<=nlapiGetLineItemCount(h);a++)if(nlapiSelectLineItem(h,a),p(a)&&!(new FreeGiftValidator(nlapiGetCurrentLineItemValue(h,f))).validateManuallyAddedFreeGift())return!1;return!0}}}();om=om||{};om.promotions=om.promotions||{};var common=om.promotions.common,PROMOTIONS_MACHINE_NAME=common.PROMOTIONS_MACHINE.NAME;PROMO_CODE=common.PROMOTIONS_MACHINE.PROMO_CODE;PROMOTION_TYPE=common.PROMOTIONS_MACHINE.PROMOTION_TYPE;
var FREE_GIFT_TYPE=common.PROMOTION_TYPES.FREEGIFT,APPLICABILITY_STATUS=common.PROMOTIONS_MACHINE.APPLICABILITY_STATUS,APPLICABILITY_REASON=common.PROMOTIONS_MACHINE.APPLICABILITY_REASON,CRITERIA_NOT_MET=common.REASON.CRITERIA_NOT_MET,NO_FREE_GIFTS_ADDED=common.REASON.NO_FREE_GIFTS_ADDED,PURCHASE_DISCOUNT=common.PROMOTIONS_MACHINE.PURCHASE_DISCOUNT,PROMOTION_DOES_NOT_APPLY_SYMBOL=common.PROMOTION_DOES_NOT_APPLY_SYMBOL,PROMOTION_TYPES=common.PROMOTION_TYPES,ITEMS_MACHINE_NAME=common.ITEM_MACHINE.NAME,
ITEM_MACHINE_QUANTITY=common.ITEM_MACHINE.QUANTITY,ITEM_MACHINE_AMOUNT=common.ITEM_MACHINE.AMOUNT,ELIGIBLE_FREE_GIFTS=common.freegift.CONSTANTS.ELIGIBLE_FREE_GIFTS,FREE_GIFTS_ADDED=common.freegift.CONSTANTS.FREE_GIFTS_ADDED,ITEM_MACHINE_FREEGIFTPROMOTION=common.freegift.CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION,PROMOTIONS_MACHINE_FREEGIFTS_ADDED=common.freegift.CONSTANTS.FREE_GIFTS_ADDED;
om.promotions.form.freegift=function(){function b(a){for(var c=0,b=0,d=1;d<nlapiGetLineItemCount(ITEMS_MACHINE_NAME)+1;d++)if(nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,PROMO_CODE,a)===nlapiGetLineItemValue(ITEMS_MACHINE_NAME,ITEM_MACHINE_FREEGIFTPROMOTION,d)){c+=parseInt(nlapiGetLineItemValue(ITEMS_MACHINE_NAME,ITEM_MACHINE_QUANTITY,d));var h=parseFloat(nlapiGetLineItemValue(ITEMS_MACHINE_NAME,ITEM_MACHINE_AMOUNT,d));h=isNaN(h)?0:h;b+=h}d=b;b=nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,FREE_GIFTS_ADDED,
a);h=nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,APPLICABILITY_REASON,a);(b===PROMOTION_DOES_NOT_APPLY_SYMBOL&&CRITERIA_NOT_MET===h&&0===c||b!==PROMOTION_DOES_NOT_APPLY_SYMBOL&&CRITERIA_NOT_MET!==h&&parseInt(b)===c)&&parseFloat(nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,PURCHASE_DISCOUNT,a))===-d||(nlapiSelectLineItem(PROMOTIONS_MACHINE_NAME,a),nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,PROMOTIONS_MACHINE_FREEGIFTS_ADDED,c,!1,!1),a=nlapiGetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,
APPLICABILITY_REASON),0<c||CRITERIA_NOT_MET!==a?(nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,FREE_GIFTS_ADDED,c,!1,!1),nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,PURCHASE_DISCOUNT,format_currency(-d),!1,!1)):(nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,FREE_GIFTS_ADDED,PROMOTION_DOES_NOT_APPLY_SYMBOL,!1,!1),nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,PURCHASE_DISCOUNT,PROMOTION_DOES_NOT_APPLY_SYMBOL,!1,!1)),NO_FREE_GIFTS_ADDED===a&&0<c&&(nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,
APPLICABILITY_STATUS,om.promotions.common.STATUS.APPLIED),nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,APPLICABILITY_REASON,om.promotions.common.REASON.NOT_AVAILABLE)),nlapiCommitLineItem(PROMOTIONS_MACHINE_NAME))}function d(a,c){return!(a.length===c.length+1&&c.every(function(c){return-1!==a.indexOf(c.id)}))}return{updateFreeGiftsAdded:function(){if(promotions.shouldRunPromotionEngine()&&promotions.shouldNewEngineRun()){promotions.setIsPromotionEngineDisabled(!0);for(var a=1;a<nlapiGetLineItemCount(PROMOTIONS_MACHINE_NAME)+
1;a++)PROMOTION_TYPES.FREEGIFT===nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,PROMOTION_TYPE,a)&&b(a);promotions.setIsPromotionEngineDisabled(!1)}},updateFreeGiftsAddedForEligibleFreeGiftPromotions:function(){if(promotions.shouldRunPromotionEngine()&&promotions.shouldNewEngineRun()){promotions.setIsPromotionEngineDisabled(!0);for(var a=1;a<nlapiGetLineItemCount(PROMOTIONS_MACHINE_NAME)+1;a++){var c=a;PROMOTION_TYPES.FREEGIFT!==nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,PROMOTION_TYPE,c)||om.promotions.common.STATUS.NOT_APPLIED===
nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,APPLICABILITY_STATUS,c)&&om.promotions.common.REASON.CRITERIA_NOT_MET===nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,APPLICABILITY_REASON,c)||b(a)}promotions.setIsPromotionEngineDisabled(!1)}},updatePromotionMachineFreeGiftsColumnsFromOuput:function(a){var c=PROMOTION_TYPES[nlapiGetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,PROMOTION_TYPE)];"undefined"!==typeof a&&0!==a.eligibleFreeGifts&&PROMOTION_TYPES.FREEGIFT===c?nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,
ELIGIBLE_FREE_GIFTS,a.eligibleFreeGifts):(nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,ELIGIBLE_FREE_GIFTS,PROMOTION_DOES_NOT_APPLY_SYMBOL,!1),PROMOTION_TYPES.FREEGIFT!==c&&nlapiSetCurrentLineItemValue(PROMOTIONS_MACHINE_NAME,FREE_GIFTS_ADDED,PROMOTION_DOES_NOT_APPLY_SYMBOL,!1))},syncFreeGiftPromotionColumn:function(){if(om.promotions.form.isUserInterface()){for(var a=[],c=1;c<=nlapiGetLineItemCount(PROMOTIONS_MACHINE_NAME);c++){var b=c,p=a,h=b,f=nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,
PROMOTION_TYPE,h),g=nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,APPLICABILITY_STATUS,h);h=nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,APPLICABILITY_REASON,h);f===FREE_GIFT_TYPE&&(om.promotions.common.STATUS.APPLIED===g||om.promotions.common.STATUS.NOT_APPLIED===g&&om.promotions.common.REASON.NO_FREE_GIFTS_ADDED===h)&&p.push({id:nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,PROMO_CODE,b),name:nlapiGetLineItemText(PROMOTIONS_MACHINE_NAME,PROMO_CODE,b)})}c=(c=nlapiGetLineItemField(ITEMS_MACHINE_NAME,
ITEM_MACHINE_FREEGIFTPROMOTION))&&c.getUIField&&c.getUIField()?c.getUIField():null;if(null!==c&&(b=getSelectValueArray(c),d(b,a)))for(deleteAllSelectOptions(c,window),addSelectOption(document,c,"","",!1),b=0;b<a.length;b++)addSelectOption(document,c,a[b].name,a[b].id,!1,window)}},isFreeGiftPromotion:function(a){return om.utils.isValueDefined(a)&&(a=common.findFirstInMachine(PROMOTIONS_MACHINE_NAME,PROMO_CODE,a),om.utils.isValueDefined(a))?nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,PROMOTION_TYPE,
a)===PROMOTION_TYPES.FREEGIFT:!1}}}();om=om||{};om.promotions=om.promotions||{};om.promotions.freegifts=om.promotions.freegifts||{};var commonFreeGift=om.promotions.common.freegift,itemsFreeGift=om.promotions.items.freegift,ITEM_MACHINE=om.promotions.common.ITEM_MACHINE.NAME,ITEM_MACHINE_ITEM=om.promotions.common.ITEM_MACHINE.ITEM;PROMOTIONS=om.promotions.common.PROMOTIONS_MACHINE.NAME;PROMO_CODE=om.promotions.common.PROMOTIONS_MACHINE.PROMO_CODE;var EVENT_ITEM_MACHINE_CHANGED=om.promotions.common.APPLY_PROMO_TRIGGER.EVENT_ITEM_MACHINE_RECALC;
om.promotions.freegifts.resumingmechanism=function(){function b(b){h=m=!1;a()&&(c=[]);"undefined"!==typeof b&&b instanceof Array&&0<b.length&&b.forEach(function(a){commonFreeGift.CONSTANTS.FREE_GIFT_STATUS_NEW===a.status&&c.push(a)})}function d(){var a=null;0<c.length&&(a=c[0]);return a}function a(){return 0<c.length||h}var c=[],m=!1,p=!1,h=!1;return{loadNewFreeGifts:b,addFreeGift:function(){if(a()&&!h)if(m=!m)p=!0,itemsFreeGift.addFreeGift(d());else if(!m){p=!1;var b=d();1===c.length&&(h=!0);c.shift();
itemsFreeGift.addFreeGiftDiscountLine(b.freeGiftPromotion,b.discountItemId,nlapiGetLineItemCount(ITEM_MACHINE));h=!1}},rejectFreeGift:function(){a()&&(c.shift(),m=!1)},rejectFreeGiftAndCopyPrevious:function(){a()&&(c.shift(),m=!0)},getCurrentFreeGift:d,isResumingFreeGifts:a,rejectAllFreeGifts:function(){b([])},isAddingCurrentFreeGift:function(){return a()&&p},shouldResumeMechanismRun:function(){return om.promotions.form.isUserInterface()&&promotions.shouldNewEngineRun()},shouldResumeMechanismContinue:function(a){return om.promotions.freegifts.resumingmechanism.isResumingFreeGifts()&&
EVENT_ITEM_MACHINE_CHANGED===a}}}();omPromotions=om.promotions;promotionsCommon=omPromotions.common;var freeGiftCommon=promotionsCommon.freegift,omPromotionsItems=omPromotions.items,resumingMechanism=omPromotions.freegifts.resumingmechanism,ITEM_MACHINE_NAME=promotionsCommon.ITEM_MACHINE.NAME;ITEM_MACHINE_ITEM=promotionsCommon.ITEM_MACHINE.ITEM;ITEM_MACHINE_QUANTITY=promotionsCommon.ITEM_MACHINE.QUANTITY;ITEM_MACHINE_FREEGIFTPROMOTION=freeGiftCommon.CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION;
var FREE_GIFT_CONSTANTS=freeGiftCommon.CONSTANTS,PROMOTIONS_MACHINE=promotionsCommon.PROMOTIONS_MACHINE.NAME,PROMOTIONS_MACHINE_ELIGIBLE_FREE_GIFTS_FIELD=freeGiftCommon.CONSTANTS.ELIGIBLE_FREE_GIFTS,FreeGiftValidator=new promotionsCommon.NLClass({initialize:function(b){this.itemLineId=parseInt(b);b=nlapiGetCurrentLineItemValue(ITEM_MACHINE_NAME,FREE_GIFT_CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION);om.utils.isValueDefined(b)?(this.freeGiftPromotionId=parseInt(b),this.indexFreeGiftPromotion=freeGiftCommon.findFreeGiftPromotionIndex(this.freeGiftPromotionId),
this.quantity=parseInt(nlapiGetCurrentLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_QUANTITY))):this.quantity=this.indexFreeGiftPromotion=this.freeGiftPromotionId=-1},validateFreeGiftAddedToItemMachine:function(){return om.promotions.isTransactionInDynamicDeferredMode()?!0:resumingMechanism.isResumingFreeGifts()?this.validateAutomaticallyAddedFreeGift():this.validateManuallyAddedFreeGift()},validateAutomaticallyAddedFreeGift:function(){var b=resumingMechanism.getCurrentFreeGift();if(this.isDiscountBeingAddedOrUserDidNotChangeProperties(b))return!0;
alert(NS.Translations.dictionary["NLAlertContext.YOU_CANNOT_CHANGE_THE_FOLLOWING_PROPERTIES_OF_A_FREE_GIFT_ITEM_THAT_IS_AUTOMATICALLY_APPLIED_TO_A_TRANSACTION"].replace(/\\n/g,"\n"));nlapiSetCurrentLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_ITEM,"",!0,!0);nlapiSetCurrentLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_ITEM,b.itemCustomerWillGet);nlapiSetCurrentLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_QUANTITY,b.quantity);nlapiSetCurrentLineItemValue(ITEM_MACHINE_NAME,FREE_GIFT_CONSTANTS.ITEM_MACHINE_FREEGIFTPROMOTION,
b.freeGiftPromotion);return!1},isDiscountBeingAddedOrUserDidNotChangeProperties:function(b){return!resumingMechanism.isAddingCurrentFreeGift()||om.utils.isValueDefined(b)&&this.itemLineId===b.itemCustomerWillGet&&this.freeGiftPromotionId===b.freeGiftPromotion&&this.quantity===b.quantity},validateManuallyAddedFreeGift:function(){if(-1===this.freeGiftPromotionId||omPromotionsItems.isLineItemADiscount(this.itemLineId)||this.isItemLineWithFreeGiftPromotionAssociationOK()&&this.isThereEnoughFreeGiftQuantity())return!0;
if(om.promotions.form.isUserInterface())alert(NS.Translations.dictionary["NLAlertContext.THIS_TRANSACTION_IS_NOT_ELIGIBLE_FOR_THE_FREE_GIFT_OPTIONS_THAT_YOU_HAVE_ENTERED_PLEASE_REVIEW_YOUR_OPTIONS"]);else throw nlapiCreateError("THIS_TRANSACTION_IS_NOT_ELIGIBLE_FOR_THE_FREE_GIFT_OPTIONS_THAT_YOU_HAVE_ENTERED_PLEASE_REVIEW_YOUR_OPTIONS","This transaction is not eligible for the free gift options that you have entered. Please review your options.",!0);return!1},isItemLineWithFreeGiftPromotionAssociationOK:function(){var b=
nlapiGetLineItemValue(PROMOTIONS_MACHINE,FREE_GIFT_CONSTANTS.PROMOTIONS_MACHINE_FREEGIFTPERPROMO,this.indexFreeGiftPromotion);if(om.utils.isValueDefined(b)&&(b=this.findFreeGiftPromotionInJSON(JSON.parse(b)),om.utils.isValueDefined(b))){var d=this.itemLineId;return b.eligibleItems.some(function(a){return d===a.itemId})}return!1},isThereEnoughFreeGiftQuantity:function(){var b=parseFloat(nlapiGetCurrentLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_QUANTITY));if(0>=b||0!==b%1)return!1;b=parseInt(nlapiGetLineItemValue(PROMOTIONS_MACHINE_NAME,
PROMOTIONS_MACHINE_ELIGIBLE_FREE_GIFTS_FIELD,this.indexFreeGiftPromotion));var d=this.sumFreeGiftAdded();return b>=d&&0<d},sumFreeGiftAdded:function(){var b=0;if(-1===this.itemLineId||-1===this.freeGiftPromotionId)return b;for(var d=nlapiGetLineItemCount(ITEM_MACHINE_NAME),a=parseInt(nlapiGetCurrentLineItemIndex(ITEM_MACHINE_NAME)),c=1;c<=d;c++)if(c!==a){var m=nlapiGetLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_FREEGIFTPROMOTION,c);om.utils.isValueDefined(m)&&this.freeGiftPromotionId===parseInt(m)&&
(b+=parseInt(nlapiGetLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_QUANTITY,c)))}return b+parseInt(nlapiGetCurrentLineItemValue(ITEM_MACHINE_NAME,ITEM_MACHINE_QUANTITY,c))},findFreeGiftPromotionInJSON:function(b){var d=this.freeGiftPromotionId;return b.promotions.filter(function(a){return d===a.id})[0]}});om=om||{};om.promotions=om.promotions||{};
om.promotions.suitepromotionmanager=function(){return{processNewEngineOutput:function(b){var d=om.utils.convertStringArrayToIntArray(Object.keys(b));if(om.promotions.engine.isInResolvingConflictMode()){for(var a in b)if(b.hasOwnProperty(a)){var c=b[a];c.applicability.status===om.promotions.common.STATUS.NOT_APPLIED&&"DISCARDED_BEST_OFFER"===c.applicability.reason&&(c.applicability.reason="DISCARDED_USER")}om.promotions.engine.setInResolvingConflictMode(!1)}d=om.promotions.form.filterOnToBeAddedPromotions(d);
om.promotions.form.addPromotionsSettingAppliedDiscounts(d,b);om.promotions.form.updatePromotionsDiscountAmount(d,b)},updateApplicability:function(b){b&&b.applicability&&(nlapiSetCurrentLineItemValue("promotions","applicabilitystatus",b.applicability.getStatus()),nlapiSetCurrentLineItemValue("promotions","applicabilityreason",b.applicability.getReason()),nlapiSetCurrentLineItemValue("promotions","applicabilitymode",b.applicability.getMode()))}}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.shipping=function(){function b(){a=d();c="UP_TO_DATE"}function d(){return om.promotions.form.isMachineAvailable("shipgroup")?om.utils.collectMachineData("shipgroup",["shippingmethodref","shippingrate","handlingrate"],!0):[]}var a=void 0,c=void 0,m=!1,p=new om.promotions.common.NLClass({initialize:function(a,c,b){this.shippingItemId=a;this.shippingCost=c;this.handlingCost=b},getShippingItemId:function(){return this.shippingItemId},getShippingCost:function(){return this.shippingCost},getHandlingCost:function(){return this.handlingCost}}),
h=new om.promotions.common.NLClass({initialize:function(a,c,b){this.shippingGroupLineNumber=a;this.shippingCost=c;this.handlingCost=b},getShippingGroupLineNumber:function(){return this.shippingGroupLineNumber},getShippingCost:function(){return this.shippingCost},getHandlingCost:function(){return this.handlingCost}});return{isMultiShippingRoute:function(){return"T"===nlapiGetFieldValue("ismultishipto")},isMultiShippingRouteError:function(a){return a&&a.errorMsg&&("WHEN_THE_TRANSACTION_HAS_MULTIPLE_SHIPPING_ROUTE_ON_PROMOTION_WITH_SHIPPING_IMPACT_IS_NOT_ALLOWED_AND_WILL_BE_REMOVED"==
a.errorMsg||"WHEN_MULTIPLE_SHIPPING_ROUTES_ARE_ACTIVATED_ON_A_TRANSACTION_PROMOTIONS_WITH_SHIPPING_IMPACT_ARE_NOT_SUPPORTED_AND_ARE_NOT_TAKEN_INTO_CONSIDERATION"==a.errorMsg)},getShippingItems:function(){return om.promotions.webstore.getShipCostList()||[new om.promotions.shipping.NLPromotionsShippingCost(nlapiGetFieldValue("shipmethod"),nlapiGetFieldValue("shippingcost"),nlapiGetFieldValue("handlingcost"))]},hasShippingRates:function(){return"function"===typeof getShippingItemRate},setExecutePromotionEngineWhenShippingIsRecalculated:function(a){m=
a},getExecutePromotionEngineWhenShippingIsRecalculated:function(){return m},collectShippingGroups:function(){"UP_TO_DATE"!==c&&b();return a},initialize:function(){a=d();c=0<a.length?"NOT_VALID_BECAUSE_OF_EDITING_SAVED_TRANSACTION":"UP_TO_DATE"},areShippingGroupsRestoreValuesNotValidBecauseOfEditingSavedTransaction:function(){return"NOT_VALID_BECAUSE_OF_EDITING_SAVED_TRANSACTION"===c},restoreShippingGroupsIfNotBeingCalculated:function(){if("CALCULATING"!==c&&(void 0===a||0!==a.length)&&a)for(var b=
0;b<a.length;b++)om.promotions.form.updateShippingGroupCost(a[b].lineNumber,a[b].shippingrate,a[b].handlingrate)},updateShippingGroupsRestoreValues:b,NLPromotionsShippingGroupCost:h,NLPromotionsShippingCost:p,onShippingGroupLineCommit:function(d){om.promotions.useNewPromotionEngine()&&(d>a.length?b():om.promotions.form.isShippingGroupCostBeingUpdated()||"CALCULATING"===c||void 0!==a&&0===a.length||(a[d-1].shippingrate=om.promotions.form.getShippingGroupShippingCost(d),a[d-1].handlingrate=om.promotions.form.getShippingGroupHandlingCost(d),
om.promotions.runPromotionEngine("shippingGroupLineCommit")))},onShippingGroupLineDelete:function(){om.promotions.useNewPromotionEngine()&&(c="CALCULATING")}}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.webstore=function(){var b=function(b){nlapiGetField("promoshipcostlist")&&(b=JSON.stringify(b),nlapiSetFieldValue("promoshipcostlist",b,!1))};return{clearItemLinePromoFields:function(b){nlapiGetLineItemField("item","__promotionamount",b)&&""!=nlapiGetLineItemValue("item","__promotionamount",b)&&nlapiSetLineItemValue("item","__promotionamount",b,"");nlapiGetLineItemField("item","__promotiondiscount",b)&&""!=nlapiGetLineItemValue("item","__promotiondiscount",b)&&nlapiSetLineItemValue("item",
"__promotiondiscount",b,"");nlapiGetLineItemField("item","__promotiontax1amount",b)&&""!=nlapiGetLineItemValue("item","__promotiontax1amount",b)&&nlapiSetLineItemValue("item","__promotiontax1amount",b,"");nlapiGetLineItemField("item","__promotiontax2amount",b)&&""!=nlapiGetLineItemValue("item","__promotiontax2amount",b)&&nlapiSetLineItemValue("item","__promotiontax2amount",b,"");nlapiGetLineItemField("item","__promotiongrossamount",b)&&""!=nlapiGetLineItemValue("item","__promotiongrossamount",b)&&
nlapiSetLineItemValue("item","__promotiongrossamount",b,"")},getShipCostList:function(){var b=nlapiGetFieldValue("shipcostlist");if(b){var a=[];if(b&&(b=JSON.parse(b))&&0<b.length)for(var c=b.length,m=0;m<c;++m){var p=b[m];a.push(new om.promotions.shipping.NLPromotionsShippingCost(p.shipmeth,p.shipcost,p.handlingcost))}return a}return null},ignoreResultDueToOptimization:function(){return this.isWebStoreRequest()&&"T"==nlapiGetFieldValue("webstoreoptimizationactive")},isWebStoreRequest:function(){return null!=
nlapiGetField("shipcostlist")},isValidWebstoreShippingMethod:function(b,a){for(var c=b.length,d=0;d<c;++d)if(a==b[d].getShippingItemId())return!0;return!1},setExcludeFromRateRequest:function(b){nlapiGetField("promoexcludefromraterequest")&&nlapiSetFieldValue("promoexcludefromraterequest",JSON.stringify(b),!1)},setItemLinePromoFields:function(){for(var b=1;b<=nlapiGetLineItemCount("item");b++)if(om.promotions.items.isLineItemAPromotionDiscount(b)){var a=b-1;if(nlapiGetLineItemField("item","__promotionamount",
a)&&nlapiGetLineItemField("item","__promotiondiscount",a)){var c=parseFloat(nlapiGetLineItemValue("item","amount",a)),m=c+parseFloat(nlapiGetLineItemValue("item","amount",a+1)),p=c-m;c=m;nlapiSetLineItemValue("item","__promotionamount",a,m);nlapiSetLineItemValue("item","__promotiondiscount",a,p);nlapiGetLineItemField("item","__promotiontax1amount",a)&&(m=parseFloat(nlapiGetLineItemValue("item","tax1amt",a))+parseFloat(nlapiGetLineItemValue("item","tax1amt",a+1)),c+=m,nlapiSetLineItemValue("item",
"__promotiontax1amount",a,m));nlapiGetLineItemField("item","__promotiontax2amount",a)&&(m=parseFloat(nlapiGetLineItemValue("item","tax2amt",a))+parseFloat(nlapiGetLineItemValue("item","tax2amt",a+1)),c+=m,nlapiSetLineItemValue("item","__promotiontax2amount",a,m));nlapiSetLineItemValue("item","__promotiongrossamount",a,c)}}},setPromoError:function(b){om.promotions.logger.promotionsLogger.log("om.promotions.webstore.setPromoError",b);"object"==typeof b&&(b=JSON.stringify(b));null!=nlapiGetFieldValue("promocodeerror")&&
nlapiSetFieldValue("promocodeerror",b,!0,!0)},setPromoShipCostList:b,setUpdatedShipCostList:function(d){if(nlapiGetFieldValue("shipcostlist")){for(var a=[],c=0,m=d.length;c<m;++c){var p=d[c];a.push({shipmeth:p.getShippingItemId(),shipcost:p.getShippingCost(),handlingcost:p.getHandlingCost()})}b(a)}}}}();om=om||{};om.promotions=om.promotions||{};
om.promotions.window=function(){return{openWithConflictiveItemExclusivePromotion:function(b,d){nlExtOpenWindow("/app/accounting/transactions/promotions/popup/handler/conflictiveitemexclusivepromotion.nl?"+jQuery.param({json:JSON.stringify(b)}),"conflictiveitempromotionpopup",600,250,null,null,d)},openWithConflictiveOrderOrShippingPromotion:function(b,d){nlExtOpenWindow("/app/accounting/transactions/promotions/popup/handler/noncombinablepromotions.nl?"+jQuery.param({json:JSON.stringify(b)}),"noncombinablepromotionspopup",
600,250,null,null,d,{close:function(){om.promotions.engine.setInResolvingConflictMode(!0);om.promotions.runPromotionEngine()}})},openWithConflictiveGlobalAndOldEngine:function(b,d){nlExtOpenWindow("/app/accounting/transactions/promotions/popup/handler/conflictivelegacyglobalpromotion.nl?"+jQuery.param({json:JSON.stringify(b)}),d,600,350)},openApplicabilityStatusSummary:function(b,d){nlExtOpenWindow("/app/accounting/transactions/promotions/popup/handler/applicabilitystatussummary.nl?"+jQuery.param({json:JSON.stringify(b)}),
d,400,230)}}}();
//# sourceMappingURL=/assets/om_promotions/421587428.map